var Le=Object.defineProperty;var Pe=(o,t,e)=>t in o?Le(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var m=(o,t,e)=>Pe(o,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();const De=200,vt=30,Ue=5,$e=1e3,Ne=500,W=.45,We=15,Ye=3e3,ze=2,pe=["#4488FF","#FF4444","#44CC44","#FFAA00","#CC44CC","#44CCCC","#FF6644","#88FF44","#4466FF","#FF44AA","#AAFF44","#44AAFF","#FF8844","#8844FF","#44FF88","#FFFF44","#FF4488","#88AAFF","#CCFF44","#44FFCC","#AA44FF","#FF6688","#44FFAA","#FFCC44","#6644FF","#FF4466","#66FF44","#44CCFF","#CCAA44","#AA44CC"];var O=(o=>(o.Brick="brick",o.Steel="steel",o.Water="water",o.Bush="bush",o.Quicksand="quicksand",o))(O||{}),G=(o=>(o.RapidFire="rapidFire",o.Speed="speed",o.Shield="shield",o.Magnet="magnet",o.Heal="heal",o.OpticalSight="opticalSight",o.Rocket="rocket",o))(G||{}),it=(o=>(o.Lobby="lobby",o.Countdown="countdown",o.Playing="playing",o.Shrinking="shrinking",o.GameOver="gameOver",o))(it||{});function ge(o){let t=o%(2*Math.PI);return t>Math.PI&&(t-=2*Math.PI),t<-Math.PI&&(t+=2*Math.PI),t}function He(o){return{x:Math.sin(o),y:-Math.cos(o)}}function Xe(o,t){return ge(t-o)}function ct(o,t,e){const s=Xe(o,t);return ge(o+s*e)}function Qt(o,t,e){return o+(t-o)*e}function Q(o,t,e){return Math.max(t,Math.min(e,o))}class jt{constructor(t,e){m(this,"x",0);m(this,"y",0);m(this,"mapWidth");m(this,"mapHeight");m(this,"initialized",!1);m(this,"viewportW",vt);m(this,"viewportH",vt);this.mapWidth=t,this.mapHeight=e}setViewport(t,e,s){this.viewportW=t/s,this.viewportH=e/s}follow(t){const e=this.viewportW/2,s=this.viewportH/2,i=Q(t.x-e,0,Math.max(0,this.mapWidth-this.viewportW)),n=Q(t.y-s,0,Math.max(0,this.mapHeight-this.viewportH));if(!this.initialized){this.x=i,this.y=n,this.initialized=!0;return}const r=.15;this.x+=(i-this.x)*r,this.y+=(n-this.y)*r}worldToScreen(t,e,s){return{sx:(t-this.x)*s,sy:(e-this.y)*s}}isVisible(t,e){return t>=this.x-1&&t<=this.x+this.viewportW+1&&e>=this.y-1&&e<=this.y+this.viewportH+1}}function At(o,t){return t*De+o}class qe{constructor(){m(this,"playerId","");m(this,"roomId","");m(this,"state",null);m(this,"camera");m(this,"obstacles",[]);m(this,"obstacleSet",new Set);m(this,"mapWidth",0);m(this,"mapHeight",0);m(this,"predictedPos",null);m(this,"predictedHullAngle",0);m(this,"predictedTurretAngle",0);this.camera=new jt(1,1)}loadMap(t){this.mapWidth=t.width,this.mapHeight=t.height,this.camera=new jt(t.width,t.height),this.obstacles=[],this.obstacleSet.clear();for(const e of t.obstacles)for(let s=0;s<e.runLength;s++){const i={x:e.x+s,y:e.y,type:e.type,hp:e.type===O.Brick?ze:9999};this.obstacles.push(i),i.type!==O.Bush&&this.obstacleSet.add(At(i.x,i.y))}}applyLocalInput(t,e,s){if(!this.state)return;const i=this.getMyTank();if(!i||!i.isAlive)return;if(this.predictedPos||(this.predictedPos={...i.position}),this.predictedTurretAngle=e,t===null){this.camera.follow(this.predictedPos);return}this.predictedHullAngle=t;const n=He(t),r=Ue,h=n.x*r*s,l=n.y*r*s;let d=this.predictedPos.x+h,c=this.predictedPos.y+l;if(d=Q(d,W,this.mapWidth-1-W),c=Q(c,W,this.mapHeight-1-W),!this.collidesWithObstacle(d,c)){this.predictedPos={x:d,y:c},this.camera.follow(this.predictedPos);return}const f=Q(this.predictedPos.x+h,W,this.mapWidth-1-W);if(!this.collidesWithObstacle(f,this.predictedPos.y)){this.predictedPos={x:f,y:this.predictedPos.y},this.camera.follow(this.predictedPos);return}const p=Q(this.predictedPos.y+l,W,this.mapHeight-1-W);if(!this.collidesWithObstacle(this.predictedPos.x,p)){this.predictedPos={x:this.predictedPos.x,y:p},this.camera.follow(this.predictedPos);return}this.camera.follow(this.predictedPos)}collidesWithObstacle(t,e){const s=Math.floor(t-W),i=Math.floor(t+W),n=Math.floor(e-W),r=Math.floor(e+W);for(let h=n;h<=r;h++)for(let l=s;l<=i;l++){if(!this.obstacleSet.has(At(l,h)))continue;const d=Q(t,l,l+1),c=Q(e,h,h+1),f=t-d,p=e-c;if(f*f+p*p<W*W)return!0}return!1}updateState(t){if(this.state=t,t.destroyedObstacles&&t.destroyedObstacles.length>0)for(const s of t.destroyedObstacles){const i=At(s.x,s.y);if(this.obstacleSet.has(i)){this.obstacleSet.delete(i);const n=this.obstacles.findIndex(r=>r.x===s.x&&r.y===s.y);n!==-1&&this.obstacles.splice(n,1)}}const e=this.getMyTank();if(e){if(this.predictedPos){const s=e.position.x-this.predictedPos.x,i=e.position.y-this.predictedPos.y,n=Math.sqrt(s*s+i*i);if(n>5)this.predictedPos={...e.position};else if(n>.05){const r=n>3?.4:n>1?.1:.05;this.predictedPos.x+=s*r,this.predictedPos.y+=i*r}}else this.predictedPos={...e.position};this.camera.follow(this.predictedPos??e.position)}}getMyTank(){var t;return(t=this.state)==null?void 0:t.tanks.find(e=>e.id===this.playerId)}getMyDisplayPosition(){var t;return this.predictedPos?this.predictedPos:(t=this.getMyTank())==null?void 0:t.position}getMyDisplayHullAngle(){return this.predictedHullAngle}getMyDisplayTurretAngle(){return this.predictedTurretAngle}}class Ge{constructor(){m(this,"keys",new Set);m(this,"mouseX",0);m(this,"mouseY",0);m(this,"mouseDown",!1);m(this,"cameraX",0);m(this,"cameraY",0);m(this,"cellPx",24);m(this,"myX",0);m(this,"myY",0);m(this,"mobileMove",null);m(this,"mobileAim",null);m(this,"mobileFire",!1);m(this,"isMobile",!1);m(this,"shopOpen",!1);m(this,"pendingShopBuy",null);m(this,"pendingUnstick",!1);m(this,"lastUnstickTime",0);window.addEventListener("keydown",t=>{var e,s;if(!(((e=t.target)==null?void 0:e.tagName)==="INPUT"||((s=t.target)==null?void 0:s.tagName)==="TEXTAREA")&&(this.keys.add(t.key),(t.key==="ь"||t.key==="Ь")&&(this.shopOpen=!this.shopOpen),t.key==="Escape"&&this.shopOpen&&(this.shopOpen=!1),this.shopOpen&&(t.key==="1"&&(this.pendingShopBuy=1,this.shopOpen=!1),t.key==="2"&&(this.pendingShopBuy=2,this.shopOpen=!1),t.key==="3"&&(this.pendingShopBuy=3,this.shopOpen=!1)),t.key===" "||t.code==="Space")){const i=Date.now();i-this.lastUnstickTime>=1e4&&(this.pendingUnstick=!0,this.lastUnstickTime=i),t.preventDefault()}}),window.addEventListener("keyup",t=>{this.keys.delete(t.key)}),window.addEventListener("blur",()=>{this.keys.clear(),this.mouseDown=!1})}setCanvas(t){t.addEventListener("mousemove",e=>{const s=t.getBoundingClientRect();this.mouseX=e.clientX-s.left,this.mouseY=e.clientY-s.top}),t.addEventListener("mousedown",e=>{e.button===0&&(this.mouseDown=!0)}),t.addEventListener("mouseup",e=>{e.button===0&&(this.mouseDown=!1)}),t.addEventListener("contextmenu",e=>e.preventDefault())}updateCamera(t,e,s){this.cameraX=t,this.cameraY=e,this.cellPx=s}updateMyPosition(t,e){this.myX=t,this.myY=e}getMoveAngle(){if(this.isMobile)return this.mobileMove;const t=this.keys.has("ArrowUp")||this.keys.has("w")||this.keys.has("W")||this.keys.has("ц")||this.keys.has("Ц"),e=this.keys.has("ArrowDown")||this.keys.has("s")||this.keys.has("S")||this.keys.has("ы")||this.keys.has("Ы"),s=this.keys.has("ArrowLeft")||this.keys.has("a")||this.keys.has("A")||this.keys.has("ф")||this.keys.has("Ф"),n=(this.keys.has("ArrowRight")||this.keys.has("d")||this.keys.has("D")||this.keys.has("в")||this.keys.has("В")?1:0)-(s?1:0),r=(e?1:0)-(t?1:0);return n===0&&r===0?null:Math.atan2(n,-r)}getAimAngle(){if(this.isMobile&&this.mobileAim!==null)return this.mobileAim;const t=this.cameraX+this.mouseX/this.cellPx,e=this.cameraY+this.mouseY/this.cellPx,s=t-this.myX,i=e-this.myY;return Math.abs(s)<.01&&Math.abs(i)<.01?0:Math.atan2(s,-i)}isFiring(){return this.isMobile?this.mobileFire:this.mouseDown}setMobileMove(t){this.mobileMove=t,this.isMobile=!0}setMobileAim(t,e){this.mobileAim=t,this.mobileFire=e,this.isMobile=!0}setIsMobile(t){this.isMobile=t}consumeShopBuy(){if(this.pendingShopBuy!==null){const t=this.pendingShopBuy;return this.pendingShopBuy=null,t}}consumeUnstick(){return this.pendingUnstick?(this.pendingUnstick=!1,!0):!1}get unstickCooldownRemaining(){return Math.max(0,1e4-(Date.now()-this.lastUnstickTime))}triggerUnstick(){const t=Date.now();t-this.lastUnstickTime>=1e4&&(this.pendingUnstick=!0,this.lastUnstickTime=t)}}O.Brick+"",O.Steel+"",O.Water+"",O.Bush+"",O.Quicksand+"";class Ve{constructor(){m(this,"obstacleGrid",new Map)}loadObstacles(t){this.obstacleGrid.clear();for(const e of t)this.obstacleGrid.set(`${e.x},${e.y}`,e)}removeObstacle(t,e){this.obstacleGrid.delete(`${t},${e}`)}render(t,e,s){const i=Math.floor(e.x),n=Math.floor(e.y),r=i+Math.ceil(e.viewportW)+1,h=n+Math.ceil(e.viewportH)+1;t.fillStyle="#3A3A3A",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.strokeStyle="#444",t.lineWidth=.5;for(let l=n;l<=h;l++){const{sy:d}=e.worldToScreen(0,l,s);t.beginPath(),t.moveTo(0,d),t.lineTo(t.canvas.width,d),t.stroke()}for(let l=i;l<=r;l++){const{sx:d}=e.worldToScreen(l,0,s);t.beginPath(),t.moveTo(d,0),t.lineTo(d,t.canvas.height),t.stroke()}for(let l=n;l<=h;l++)for(let d=i;d<=r;d++){const c=this.obstacleGrid.get(`${d},${l}`);if(!c||c.type===O.Bush)continue;const{sx:f,sy:p}=e.worldToScreen(d,l,s);if(c.type===O.Brick){t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(f+2,p+2,s,s);const u=t.createLinearGradient(f,p,f+s,p+s);u.addColorStop(0,"#D85A3F"),u.addColorStop(.5,"#C84B31"),u.addColorStop(1,"#A33A1D"),t.fillStyle=u,t.fillRect(f,p,s,s),t.strokeStyle="#8B2F1F",t.lineWidth=2,t.strokeRect(f,p,s,s),t.strokeStyle="#9A3520",t.lineWidth=1.5,t.beginPath(),t.moveTo(f,p+s/2),t.lineTo(f+s,p+s/2),t.stroke();const g=l%2*(s/2);t.beginPath(),t.moveTo(f+s/2+g,p),t.lineTo(f+s/2+g,p+s/2),t.stroke(),t.strokeStyle="rgba(255, 150, 100, 0.3)",t.lineWidth=1,t.strokeRect(f+1,p+1,2,2),c.hp<=4&&(t.strokeStyle="#000",t.lineWidth=1,t.beginPath(),t.moveTo(f+s*.3,p+s*.2),t.lineTo(f+s*.5,p+s*.45),t.stroke()),c.hp<=3&&(t.beginPath(),t.moveTo(f+s*.5,p+s*.45),t.lineTo(f+s*.7,p+s*.8),t.stroke()),c.hp<=2&&(t.beginPath(),t.moveTo(f+s*.6,p+s*.1),t.lineTo(f+s*.4,p+s*.4),t.lineTo(f+s*.2,p+s*.6),t.stroke(),t.fillStyle="rgba(0, 0, 0, 0.15)",t.fillRect(f,p,s,s)),c.hp<=1&&(t.fillStyle="rgba(58, 58, 58, 0.8)",t.beginPath(),t.arc(f+s*.35,p+s*.4,s*.12,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(f+s*.7,p+s*.65,s*.08,0,Math.PI*2),t.fill())}if(c.type===O.Steel){t.fillStyle="rgba(0, 0, 0, 0.4)",t.fillRect(f+2,p+2,s,s);const u=t.createLinearGradient(f,p,f+s,p+s);u.addColorStop(0,"#A0A5A8"),u.addColorStop(.3,"#7F8487"),u.addColorStop(.7,"#6A6E70"),u.addColorStop(1,"#505458"),t.fillStyle=u,t.fillRect(f,p,s,s),t.fillStyle="rgba(255, 255, 255, 0.3)",t.fillRect(f,p,s,2),t.fillRect(f,p,2,s),t.fillStyle="rgba(0, 0, 0, 0.3)",t.fillRect(f,p+s-2,s,2),t.fillRect(f+s-2,p,2,s),t.fillStyle="rgba(255, 255, 255, 0.4)",t.fillRect(f+s*.15,p+s*.15,s*.25,s*.25),t.fillStyle="rgba(255, 255, 255, 0.2)",t.fillRect(f+s*.6,p+s*.5,s*.3,s*.3),t.fillStyle="#505458";const g=s*.08;for(let a=0;a<2;a++)for(let y=0;y<2;y++){const b=f+s*(.2+a*.6),v=p+s*(.2+y*.6);t.beginPath(),t.arc(b,v,g,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.5)",t.beginPath(),t.arc(b-g*.3,v-g*.3,g*.4,0,Math.PI*2),t.fill(),t.fillStyle="#505458"}}if(c.type===O.Water){const u=Date.now()/800,g=t.createLinearGradient(f,p,f,p+s);g.addColorStop(0,"#2A8CFF"),g.addColorStop(.5,"#1A73E8"),g.addColorStop(1,"#0D5BBF"),t.fillStyle=g,t.fillRect(f,p,s,s),t.strokeStyle="rgba(255, 255, 255, 0.15)",t.lineWidth=1.5;for(let a=0;a<2;a++){t.beginPath();for(let y=0;y<=s;y+=2){const b=Math.sin((u+d+l+y/10+a*.5)*2)*1.5;y===0?t.moveTo(f+y,p+s*(.3+a*.3)+b):t.lineTo(f+y,p+s*(.3+a*.3)+b)}t.stroke()}t.fillStyle=`rgba(255, 255, 255, ${.2+Math.sin(u+d)*.1})`,t.beginPath(),t.arc(f+s*.3,p+s*.4,s*.15,0,Math.PI*2),t.fill(),t.fillStyle=`rgba(255, 255, 255, ${.15+Math.sin(u+l)*.08})`,t.beginPath(),t.arc(f+s*.7,p+s*.6,s*.12,0,Math.PI*2),t.fill()}if(c.type===O.Quicksand){const u=Date.now()/1500,g=t.createRadialGradient(f+s/2,p+s/2,0,f+s/2,p+s/2,s*.8);g.addColorStop(0,"#E8C896"),g.addColorStop(.5,"#D4A574"),g.addColorStop(1,"#B8875C"),t.fillStyle=g,t.fillRect(f,p,s,s),t.strokeStyle="rgba(160, 120, 80, 0.3)",t.lineWidth=1.5;for(let b=0;b<3;b++){t.beginPath();const v=u+b*Math.PI/1.5,S=s*(.2+b*.1);for(let k=0;k<Math.PI*2;k+=.3){const T=f+s/2+Math.cos(k+v)*S,F=p+s/2+Math.sin(k+v)*S;k===0?t.moveTo(T,F):t.lineTo(T,F)}t.closePath(),t.stroke()}const a=t.createRadialGradient(f+s/2,p+s/2,0,f+s/2,p+s/2,s*.15);a.addColorStop(0,"rgba(80, 60, 40, 0.6)"),a.addColorStop(1,"rgba(80, 60, 40, 0)"),t.fillStyle=a,t.beginPath(),t.arc(f+s/2,p+s/2,s*.2,0,Math.PI*2),t.fill();const y=Math.sin(u*2)*.1;t.strokeStyle=`rgba(200, 160, 120, ${.2+y})`,t.lineWidth=1,t.beginPath(),t.arc(f+s/2,p+s/2,s*(.35+y),0,Math.PI*2),t.stroke()}}}renderBushes(t,e,s){const i=Math.floor(e.x),n=Math.floor(e.y),r=i+Math.ceil(e.viewportW)+1,h=n+Math.ceil(e.viewportH)+1;for(let l=n;l<=h;l++)for(let d=i;d<=r;d++){const c=this.obstacleGrid.get(`${d},${l}`);if(!c||c.type!==O.Bush)continue;const{sx:f,sy:p}=e.worldToScreen(d,l,s),u=[{x:.25,y:.3,r:.22},{x:.55,y:.35,r:.25},{x:.7,y:.6,r:.2},{x:.3,y:.65,r:.23}];for(const g of u){const a=f+s*g.x,y=p+s*g.y,b=s*g.r;t.fillStyle="rgba(0, 0, 0, 0.2)",t.beginPath(),t.arc(a+b*.2,y+b*.2,b,0,Math.PI*2),t.fill();const v=t.createRadialGradient(a-b*.3,y-b*.3,0,a,y,b);v.addColorStop(0,"#52B788"),v.addColorStop(.5,"#40916C"),v.addColorStop(1,"#2D6A4F"),t.fillStyle=v,t.beginPath(),t.arc(a,y,b,0,Math.PI*2),t.fill(),t.fillStyle="rgba(130, 220, 150, 0.4)",t.beginPath(),t.arc(a-b*.3,y-b*.3,b*.4,0,Math.PI*2),t.fill()}}}}const Ke=12,Je=16;class Qe{constructor(){m(this,"hullAngles",new Map);m(this,"turretAngles",new Map);m(this,"lastTime",performance.now());m(this,"customColors",null)}render(t,e,s,i,n){const r=performance.now(),h=Math.min((r-this.lastTime)/1e3,.1);this.lastTime=r;for(const l of e){if(!l.isAlive||!s.isVisible(l.position.x,l.position.y))continue;const{sx:d,sy:c}=s.worldToScreen(l.position.x,l.position.y,i),f=d+i/2,p=c+i/2,u=this.smoothAngle(this.hullAngles,l.id,l.hullAngle,Ke,h),g=this.smoothAngle(this.turretAngles,l.id,l.turretAngle,Je,h),a=i*l.tankRadius,y=l.id===n&&this.customColors?this.customColors:je(l.color);t.save(),t.globalAlpha=.3,t.fillStyle="#000",t.beginPath(),t.ellipse(f+a*.15,p+a*.15,a*1.1,a*.9,0,0,Math.PI*2),t.fill(),t.globalAlpha=1,t.restore(),t.save(),t.translate(f,p),t.rotate(u);const b=t.createLinearGradient(-a,-a,-a,a);b.addColorStop(0,U(y.treads,-40)),b.addColorStop(.3,y.treads),b.addColorStop(.7,U(y.treads,-10)),b.addColorStop(1,U(y.treads,-50)),t.fillStyle=b,t.fillRect(-a*1.05,-a,a*.35,a*2),t.fillStyle="rgba(0,0,0,0.3)",t.fillRect(-a*1.05,-a,a*.1,a*2),t.fillStyle=b,t.fillRect(a*.7,-a,a*.35,a*2),t.fillStyle="rgba(0,0,0,0.3)",t.fillRect(a*.7,-a,a*.1,a*2),t.fillStyle=U(y.treads,-60);for(let T=0;T<6;T++){const F=-a+T/5*(a*2);t.beginPath(),t.arc(-a*.87,F,a*.05,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a*.87,F,a*.05,0,Math.PI*2),t.fill()}const v=t.createLinearGradient(-a*.65,-a*.8,a*.65,a*.8);v.addColorStop(0,U(y.body,-20)),v.addColorStop(.3,y.body),v.addColorStop(.5,U(y.body,20)),v.addColorStop(.7,y.body),v.addColorStop(1,U(y.body,-10)),t.fillStyle=v,t.fillRect(-a*.65,-a*.8,a*1.3,a*1.6),t.strokeStyle=U(y.body,40),t.lineWidth=2,t.strokeRect(-a*.65,-a*.8,a*1.3,a*1.6),t.strokeStyle=U(y.body,-30),t.lineWidth=1,t.strokeRect(-a*.5,-a*.65,a,a*1.3),t.restore(),t.save(),t.translate(f,p),t.rotate(g),t.fillStyle="rgba(0,0,0,0.2)",t.beginPath(),t.arc(0,a*.05,a*.42,0,Math.PI*2),t.fill();const S=t.createRadialGradient(-a*.15,-a*.15,0,0,0,a*.4);S.addColorStop(0,U(y.turret,30)),S.addColorStop(.5,U(y.turret,-10)),S.addColorStop(1,U(y.turret,-40)),t.fillStyle=S,t.beginPath(),t.arc(0,0,a*.4,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.3)",t.beginPath(),t.arc(-a*.1,-a*.1,a*.15,0,Math.PI*2),t.fill();const k=t.createLinearGradient(-a*.12,0,a*.12,0);if(k.addColorStop(0,U(y.barrel,-40)),k.addColorStop(.5,y.barrel),k.addColorStop(1,U(y.barrel,-30)),t.fillStyle=k,t.fillRect(-a*.1,-a*1.2,a*.2,a*.8),t.fillStyle="#000",t.fillRect(-a*.1,-a*1.2,a*.2,a*.1),t.fillStyle=U(y.barrel,20),t.fillRect(-a*.08,-a*1.15,a*.03,a*.65),t.restore(),this.renderHPBar(t,d,c,i,l),l.id!==n&&(t.fillStyle="#FFF",t.font=`${Math.max(8,i/3)}px Arial`,t.textAlign="center",t.textBaseline="bottom",t.fillText(l.name,f,c-i*.15)),l.stars>0&&(t.fillStyle="#FFD700",t.font=`bold ${Math.max(7,i/4)}px Arial`,t.textAlign="center",t.textBaseline="top",t.fillText(`${l.stars}`,f,c+i+2)),l.hasFlag){const T=l.team==="a"?"#FF4444":"#4488FF",F=i*.4;t.fillStyle=T,t.beginPath(),t.moveTo(f+a,p-a),t.lineTo(f+a+F*.6,p-a+F*.25),t.lineTo(f+a,p-a+F*.5),t.closePath(),t.fill(),t.strokeStyle="#AAA",t.lineWidth=1,t.beginPath(),t.moveTo(f+a,p-a),t.lineTo(f+a,p-a+F*.7),t.stroke()}}}smoothAngle(t,e,s,i,n){let r=t.get(e)??s,h=s-r;for(;h>Math.PI;)h-=Math.PI*2;for(;h<-Math.PI;)h+=Math.PI*2;return Math.abs(h)<.01?r=s:r+=Math.sign(h)*Math.min(Math.abs(h),i*n),t.set(e,r),r}renderHPBar(t,e,s,i,n){const r=i*.8,h=3,l=e+(i-r)/2,d=s-6;t.fillStyle="#333",t.fillRect(l,d,r,h);const c=n.hp/n.maxHp,f=c>.5?"#44CC44":c>.25?"#FFAA00":"#FF4444";t.fillStyle=f,t.fillRect(l,d,r*c,h)}}function je(o){return{treads:U(o,-60),body:o,turret:U(o,-10),barrel:U(o,-50)}}function U(o,t){const e=o.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(e){const h=Math.max(0,Math.min(255,parseInt(e[1])+t)),l=Math.max(0,Math.min(255,parseInt(e[2])+t)),d=Math.max(0,Math.min(255,parseInt(e[3])+t));return`rgb(${h},${l},${d})`}const s=parseInt(o.slice(1),16),i=Math.max(0,Math.min(255,(s>>16&255)+t)),n=Math.max(0,Math.min(255,(s>>8&255)+t)),r=Math.max(0,Math.min(255,(s&255)+t));return`rgb(${i},${n},${r})`}class Ze{render(t,e,s,i){for(const n of e){if(!s.isVisible(n.position.x,n.position.y))continue;const{sx:r,sy:h}=s.worldToScreen(n.position.x,n.position.y,i),l=r+i/2,d=h+i/2;n.isRocket?this.renderRocket(t,l,d,n,i):this.renderBullet(t,l,d,n,i)}}renderBullet(t,e,s,i,n){const r=n*.12,h=n*.8,l=Math.min(h,i.distanceTraveled*n);if(l>n*.05){const c=e-Math.sin(i.angle)*l,f=s+Math.cos(i.angle)*l,p=t.createLinearGradient(c,f,e,s);p.addColorStop(0,"rgba(255, 100, 0, 0)"),p.addColorStop(.5,"rgba(255, 150, 0, 0.2)"),p.addColorStop(1,"rgba(255, 200, 0, 0.5)"),t.strokeStyle=p,t.lineWidth=n*.2,t.lineCap="round",t.beginPath(),t.moveTo(c,f),t.lineTo(e,s),t.stroke();const u=t.createLinearGradient(c,f,e,s);u.addColorStop(0,"rgba(255, 220, 100, 0)"),u.addColorStop(.6,"rgba(255, 230, 150, 0.5)"),u.addColorStop(1,"rgba(255, 255, 200, 0.8)"),t.strokeStyle=u,t.lineWidth=n*.08,t.beginPath(),t.moveTo(c,f),t.lineTo(e,s),t.stroke()}const d=t.createRadialGradient(e-r*.3,s-r*.3,0,e,s,r);d.addColorStop(0,"#FFFFD0"),d.addColorStop(.4,"#FFD700"),d.addColorStop(1,"#FF8800"),t.fillStyle=d,t.beginPath(),t.arc(e,s,r,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255, 255, 255, 0.8)",t.beginPath(),t.arc(e-r*.2,s-r*.2,r*.35,0,Math.PI*2),t.fill()}renderRocket(t,e,s,i,n){const r=n*.22,h=n*1.2,l=Math.min(h,i.distanceTraveled*n);if(l>n*.05){const c=e-Math.sin(i.angle)*l,f=s+Math.cos(i.angle)*l,p=t.createLinearGradient(c,f,e,s);p.addColorStop(0,"rgba(100, 100, 100, 0)"),p.addColorStop(.3,"rgba(150, 150, 150, 0.15)"),p.addColorStop(.7,"rgba(200, 100, 50, 0.3)"),p.addColorStop(1,"rgba(255, 150, 50, 0.6)"),t.strokeStyle=p,t.lineWidth=n*.35,t.lineCap="round",t.beginPath(),t.moveTo(c,f),t.lineTo(e,s),t.stroke();const u=t.createLinearGradient(c,f,e,s);u.addColorStop(0,"rgba(255, 100, 0, 0)"),u.addColorStop(.5,"rgba(255, 200, 50, 0.4)"),u.addColorStop(1,"rgba(255, 255, 100, 0.8)"),t.strokeStyle=u,t.lineWidth=n*.12,t.beginPath(),t.moveTo(c,f),t.lineTo(e,s),t.stroke()}t.save(),t.translate(e,s),t.rotate(i.angle);const d=t.createLinearGradient(-r*.4,0,r*.4,0);d.addColorStop(0,"#AA2200"),d.addColorStop(.5,"#FF4400"),d.addColorStop(1,"#CC3300"),t.fillStyle=d,t.beginPath(),t.ellipse(0,0,r*.4,r,0,0,Math.PI*2),t.fill(),t.fillStyle="#FF6600",t.beginPath(),t.moveTo(-r*.25,-r),t.lineTo(0,-r*1.3),t.lineTo(r*.25,-r),t.closePath(),t.fill(),t.fillStyle="rgba(255, 200, 50, 0.6)",t.beginPath(),t.arc(0,r*.8,r*.3,0,Math.PI*2),t.fill(),t.restore(),t.save(),t.globalAlpha=.3,t.fillStyle="#FF6600",t.beginPath(),t.arc(e,s,r*1.3,0,Math.PI*2),t.fill(),t.restore()}}class xe{constructor(){m(this,"shopOpen",!1);m(this,"showStuckHint",!1);m(this,"unstickCooldownMs",0);m(this,"isMobile",!1);m(this,"stuckButtonRect",null)}get s(){return this.isMobile?1.4:1}render(t,e,s){const i=t.canvas.width,n=t.canvas.height,r=this.s,h=Math.round(12*r);s&&(this.renderStarCounter(t,h,h,s),this.renderHpBar(t,h,h+Math.round(48*r),s),this.renderKillsCounter(t,h,h+Math.round(80*r),s),s.activePowerUp&&this.renderPowerUpIndicator(t,h,h+Math.round(108*r),s,e.timestamp)),this.renderGameInfo(t,i,h,e),this.renderLeaderboard(t,e,s==null?void 0:s.id),e.ctf&&(this.renderCTFScores(t,i,e.ctf,e.ctfTimeRemaining??0),s!=null&&s.hasFlag&&this.renderFlagCarrierWarning(t,i,n),e.ctfTimeRemaining!==void 0&&e.ctfTimeRemaining<=7&&e.ctfTimeRemaining>0&&this.renderCountdown(t,i,n,e.ctfTimeRemaining)),this.showStuckHint&&(s!=null&&s.isAlive)?this.renderStuckHint(t,i,n):this.stuckButtonRect=null,this.shopOpen&&s&&this.renderShop(t,i,n,s)}renderStarCounter(t,e,s,i){const n=this.s,r=Math.round(140*n),h=Math.round(38*n),l=t.createLinearGradient(e,s,e+r,s);l.addColorStop(0,"rgba(40, 30, 0, 0.7)"),l.addColorStop(1,"rgba(40, 30, 0, 0.3)"),t.fillStyle=l,this.roundRect(t,e,s,r,h,8),t.fill(),t.strokeStyle="rgba(255, 215, 0, 0.5)",t.lineWidth=1,this.roundRect(t,e,s,r,h,8),t.stroke();const d=e+Math.round(22*n),c=s+h/2,f=Math.round(10*n);this.drawStarShape(t,d,c,f),t.fillStyle="#FFD700",t.font=`bold ${Math.round(20*n)}px Arial`,t.textAlign="left",t.textBaseline="middle",t.shadowColor="rgba(255, 215, 0, 0.5)",t.shadowBlur=6,t.fillText(`${i.stars}`,e+Math.round(38*n),s+h/2),t.shadowBlur=0}renderHpBar(t,e,s,i){const n=this.s,r=Math.round(140*n),h=Math.round(22*n);t.fillStyle="rgba(0, 0, 0, 0.5)",this.roundRect(t,e,s,r,h,4),t.fill();const l=i.hp/i.maxHp,d=r*l,c=t.createLinearGradient(e,s,e,s+h);l>.5?(c.addColorStop(0,"#66DD66"),c.addColorStop(1,"#33AA33")):l>.25?(c.addColorStop(0,"#FFCC44"),c.addColorStop(1,"#DD9900")):(c.addColorStop(0,"#FF5555"),c.addColorStop(1,"#CC2222")),t.fillStyle=c,d>0&&(this.roundRect(t,e,s,d,h,4),t.fill()),t.fillStyle="#FFF",t.font=`bold ${Math.round(12*n)}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(`${i.hp} / ${i.maxHp}`,e+r/2,s+h/2),t.strokeStyle="rgba(255, 255, 255, 0.3)",t.lineWidth=1,this.roundRect(t,e,s,r,h,4),t.stroke()}renderKillsCounter(t,e,s,i){const n=this.s;t.fillStyle="rgba(0, 0, 0, 0.4)",this.roundRect(t,e,s,Math.round(140*n),Math.round(22*n),4),t.fill(),t.fillStyle="#FF6666",t.font=`bold ${Math.round(13*n)}px Arial`,t.textAlign="left",t.textBaseline="middle",t.fillText(`Kills: ${i.kills}`,e+Math.round(10*n),s+Math.round(11*n))}renderPowerUpIndicator(t,e,s,i,n){const r={rapidFire:"#FF4444",speed:"#44FF44",shield:"#4488FF",magnet:"#FFD700",heal:"#FF66FF",opticalSight:"#FF2222",rocket:"#FF6600"},h={rapidFire:"Rapid Fire",speed:"Speed",shield:"Shield",magnet:"Magnet",heal:"Heal",opticalSight:"Laser Sight",rocket:"Rockets"},l=this.s,d=r[i.activePowerUp]??"#FFF",c=Math.round(160*l),f=Math.round(32*l);if(t.fillStyle="rgba(0, 0, 0, 0.5)",this.roundRect(t,e,s,c,f,6),t.fill(),t.fillStyle=d,t.beginPath(),t.arc(e+Math.round(14*l),s+f/2,Math.round(6*l),0,Math.PI*2),t.fill(),t.fillStyle=d,t.font=`bold ${Math.round(12*l)}px Arial`,t.textAlign="left",t.textBaseline="middle",t.fillText(h[i.activePowerUp]??i.activePowerUp,e+Math.round(26*l),s+f/2),i.powerUpEndTime>0){const u=Math.max(0,(i.powerUpEndTime-n)/1e3).toFixed(1)+"s";t.fillStyle="#FFF",t.font=`bold ${Math.round(11*l)}px Arial`,t.textAlign="right",t.fillText(u,e+c-Math.round(8*l),s+f/2);const g=e+4,a=s+f-Math.round(5*l),y=c-8,b=Math.round(3*l),S=Math.min(1,Math.max(0,(i.powerUpEndTime-n)/1e4));t.fillStyle="rgba(255, 255, 255, 0.15)",t.fillRect(g,a,y,b),t.fillStyle=d,t.fillRect(g,a,y*S,b)}}renderGameInfo(t,e,s,i){const n=this.s,r=Math.round(140*n),h=Math.round(44*n);t.fillStyle="rgba(0, 0, 0, 0.5)",this.roundRect(t,e-r-s,s,r,h,8),t.fill(),t.strokeStyle="rgba(255, 255, 255, 0.2)",t.lineWidth=1,this.roundRect(t,e-r-s,s,r,h,8),t.stroke(),t.fillStyle="#FFF",t.font=`bold ${Math.round(14*n)}px Arial`,t.textAlign="right",t.textBaseline="top",t.fillText(`Alive: ${i.playersAlive}`,e-s-Math.round(10*n),s+Math.round(6*n));const l=Math.floor(i.timeElapsed/6e4),d=Math.floor(i.timeElapsed%6e4/1e3);t.fillStyle="#AAA",t.font=`${Math.round(13*n)}px Arial`,t.fillText(`${l}:${d.toString().padStart(2,"0")}`,e-s-Math.round(10*n),s+Math.round(24*n))}renderLeaderboard(t,e,s){const i=this.s,n=t.canvas.width,r=e.leaderboard.slice(0,5),h=Math.round(160*i),l=Math.round(18*i),d=Math.round(24*i)+r.length*l,c=n-h-Math.round(12*i),f=Math.round(66*i);t.fillStyle="rgba(0, 0, 0, 0.45)",this.roundRect(t,c,f,h,d,6),t.fill(),t.fillStyle="#FFD700",t.font=`bold ${Math.round(11*i)}px Arial`,t.textAlign="left",t.textBaseline="top",t.fillText("LEADERBOARD",c+Math.round(10*i),f+Math.round(5*i)),t.font=`${Math.round(11*i)}px Arial`;for(let p=0;p<r.length;p++){const u=r[p],g=f+Math.round(22*i)+p*l,a=u.id===s;a&&(t.fillStyle="rgba(255, 215, 0, 0.15)",t.fillRect(c+2,g-2,h-4,Math.round(16*i))),t.fillStyle=a?"#FFD700":u.isAlive?"#FFF":"#666";const y=u.name.length>10?u.name.slice(0,10)+"..":u.name;t.textAlign="left",t.fillText(`${p+1}. ${y}`,c+Math.round(10*i),g),t.textAlign="right",t.fillText(`${u.stars}`,c+h-Math.round(10*i),g),t.textAlign="left"}}renderCTFScores(t,e,s,i){const n=this.s,r=Math.round(160*n),h=Math.round(52*n),l=(e-r)/2,d=Math.round(10*n);t.fillStyle="rgba(0, 0, 0, 0.6)",this.roundRect(t,l,d,r,h,8),t.fill(),t.font=`bold ${Math.round(18*n)}px Arial`,t.textBaseline="middle";const c=d+Math.round(18*n);t.fillStyle="#4488FF",t.textAlign="right",t.fillText(`${s.scoreA}`,l+r/2-Math.round(12*n),c),t.fillStyle="#AAA",t.textAlign="center",t.fillText(":",l+r/2,c),t.fillStyle="#FF4444",t.textAlign="left",t.fillText(`${s.scoreB}`,l+r/2+Math.round(12*n),c);const f=Math.floor(i/60),p=i%60,u=`${f}:${p.toString().padStart(2,"0")}`;if(i<=10){const a=.7+.3*Math.sin(Date.now()/150);t.fillStyle=`rgba(255, 50, 50, ${a})`,t.font=`bold ${Math.round(14*n)}px Arial`}else t.fillStyle="#CCC",t.font=`${Math.round(13*n)}px Arial`;t.textAlign="center",t.fillText(u,l+r/2,d+Math.round(40*n))}renderFlagCarrierWarning(t,e,s){const i=this.s,n=.6+.4*Math.sin(Date.now()/200);t.fillStyle=`rgba(255, 215, 0, ${n})`,t.font=`bold ${Math.round(18*i)}px Arial`,t.textAlign="center",t.textBaseline="top",t.fillText("У ТЕБЯ ФЛАГ!",e/2,Math.round(52*i))}renderCountdown(t,e,s,i){const n=Math.ceil(i);if(n<=0||n>7)return;const r=1-(i-Math.floor(i)),h=n===i?0:r,l=1+h*1.5,d=Math.max(0,.35*(1-h*1.1));if(d<=0)return;t.save(),t.globalAlpha=d,t.shadowColor="#FF3333",t.shadowBlur=15*l;const c=Math.min(e,s)*.25*l;t.font=`bold ${c}px Arial`,t.textAlign="center",t.textBaseline="middle",t.strokeStyle="rgba(0, 0, 0, 0.6)",t.lineWidth=c*.06,t.strokeText(`${n}`,e/2,s/2);const f=t.createLinearGradient(e/2,s/2-c/2,e/2,s/2+c/2);f.addColorStop(0,"#FF4444"),f.addColorStop(.5,"#FF6622"),f.addColorStop(1,"#FF4444"),t.fillStyle=f,t.fillText(`${n}`,e/2,s/2),t.shadowBlur=0,t.globalAlpha=1,t.restore()}renderStuckHint(t,e,s){const i=this.s,n=this.unstickCooldownMs>0,r=.6+.3*Math.sin(Date.now()/300),h=this.isMobile?n?`ЗАСТРЯЛ (${Math.ceil(this.unstickCooldownMs/1e3)}с)`:"ЗАСТРЯЛ? НАЖМИ!":n?`ПРОБЕЛ (${Math.ceil(this.unstickCooldownMs/1e3)}с)`:"Нажми ПРОБЕЛ если застрял",l=n?`rgba(150, 150, 150, ${r})`:`rgba(255, 220, 100, ${r})`;t.font=`bold ${Math.round(14*i)}px Arial`;const d=t.measureText(h).width+Math.round(30*i)||250,c=this.isMobile?Math.round(44*i):30,f=(e-d)/2,p=s-c-(this.isMobile?20:30);this.stuckButtonRect={x:f,y:p,w:d,h:c},t.fillStyle=this.isMobile?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, 0.5)",this.roundRect(t,f,p,d,c,8),t.fill(),this.isMobile&&!n&&(t.strokeStyle="rgba(255, 220, 100, 0.6)",t.lineWidth=2,this.roundRect(t,f,p,d,c,8),t.stroke()),t.fillStyle=l,t.textAlign="center",t.textBaseline="middle",t.fillText(h,e/2,p+c/2)}renderShop(t,e,s,i){const n=this.s,r=Math.round(280*n),h=Math.round(180*n),l=(e-r)/2,d=(s-h)/2;t.fillStyle="rgba(0, 0, 0, 0.6)",t.fillRect(0,0,e,s),t.fillStyle="rgba(20, 20, 40, 0.95)",this.roundRect(t,l,d,r,h,12),t.fill(),t.strokeStyle="rgba(255, 215, 0, 0.6)",t.lineWidth=2,this.roundRect(t,l,d,r,h,12),t.stroke(),t.fillStyle="#FFD700",t.font=`bold ${Math.round(18*n)}px Arial`,t.textAlign="center",t.textBaseline="top",t.fillText("SHOP",l+r/2,d+Math.round(12*n)),t.fillStyle="#FFF",t.font=`${Math.round(13*n)}px Arial`,t.fillText(`Stars: ${i.stars}`,l+r/2,d+Math.round(36*n));const c=[{key:"1",name:"Speed Boost",desc:"+50% speed (10s)",cost:2,color:"#44FF44"},{key:"2",name:"+2 HP",desc:"Instant heal",cost:2,color:"#FF66FF"},{key:"3",name:"x2 Damage",desc:"Rockets (10s)",cost:2,color:"#FF6600"}],f=d+Math.round(58*n),p=Math.round(32*n),u=Math.round(6*n);for(let g=0;g<c.length;g++){const a=c[g],y=f+g*(p+u),b=i.stars>=a.cost;t.fillStyle=b?"rgba(255, 255, 255, 0.08)":"rgba(255, 255, 255, 0.03)",this.roundRect(t,l+Math.round(12*n),y,r-Math.round(24*n),p,6),t.fill(),t.fillStyle=b?a.color:"#555",t.font=`bold ${Math.round(14*n)}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText(`[${a.key}]`,l+Math.round(36*n),y+p/2),t.fillStyle=b?"#FFF":"#666",t.font=`bold ${Math.round(13*n)}px Arial`,t.textAlign="left",t.fillText(a.name,l+Math.round(58*n),y+p/2),t.fillStyle=b?"#FFD700":"#555",t.font=`${Math.round(12*n)}px Arial`,t.textAlign="right",t.fillText(`${a.cost} stars`,l+r-Math.round(20*n),y+p/2)}t.fillStyle="rgba(255, 255, 255, 0.4)",t.font=`${Math.round(11*n)}px Arial`,t.textAlign="center",t.fillText("Press Esc or Ь to close",l+r/2,d+h-Math.round(14*n))}drawStarShape(t,e,s,i){t.shadowColor="#FFD700",t.shadowBlur=8;const n=t.createRadialGradient(e,s,0,e,s,i);n.addColorStop(0,"#FFFFD0"),n.addColorStop(.5,"#FFD700"),n.addColorStop(1,"#CC9900"),t.fillStyle=n,t.beginPath();for(let r=0;r<5;r++){const h=r*4*Math.PI/5-Math.PI/2,l=h+Math.PI/5,d=i,c=i*.4;r===0?t.moveTo(e+d*Math.cos(h),s+d*Math.sin(h)):t.lineTo(e+d*Math.cos(h),s+d*Math.sin(h)),t.lineTo(e+c*Math.cos(l),s+c*Math.sin(l))}t.closePath(),t.fill(),t.shadowBlur=0}roundRect(t,e,s,i,n,r){t.beginPath(),t.moveTo(e+r,s),t.lineTo(e+i-r,s),t.quadraticCurveTo(e+i,s,e+i,s+r),t.lineTo(e+i,s+n-r),t.quadraticCurveTo(e+i,s+n,e+i-r,s+n),t.lineTo(e+r,s+n),t.quadraticCurveTo(e,s+n,e,s+n-r),t.lineTo(e,s+r),t.quadraticCurveTo(e,s,e+r,s),t.closePath()}}const ts=150,es=10,ss=typeof window<"u"&&"ontouchstart"in window;class is{constructor(){m(this,"obstacleCanvas",null);m(this,"obstacleCount",-1)}render(t,e,s,i,n,r,h){const l=ss?1.3:1,d=Math.round(ts*l),c=Math.round(es*l),f=t.canvas.width,p=t.canvas.height,u=f-d-c,g=p-d-c;t.fillStyle="rgba(0,0,0,0.6)",t.fillRect(u,g,d,d),t.strokeStyle="#666",t.lineWidth=1,t.strokeRect(u,g,d,d);const a=d/i,y=d/n;if(h&&h.length>0){if(!this.obstacleCanvas||this.obstacleCount!==h.length){this.obstacleCanvas=new OffscreenCanvas(d,d),this.obstacleCount=h.length;const S=this.obstacleCanvas.getContext("2d"),k={[O.Brick]:"rgba(160, 120, 80, 0.7)",[O.Steel]:"rgba(180, 180, 190, 0.8)",[O.Water]:"rgba(40, 100, 200, 0.5)",[O.Bush]:"rgba(40, 130, 40, 0.4)",[O.Quicksand]:"rgba(180, 160, 80, 0.4)"};for(const T of[O.Steel,O.Brick,O.Water,O.Quicksand,O.Bush]){S.fillStyle=k[T]??"rgba(128,128,128,0.5)";for(const F of h){if(F.type!==T)continue;const E=F.x*a,M=F.y*y,w=Math.max(1,Math.ceil(a)),_=Math.max(1,Math.ceil(y));S.fillRect(E,M,w,_)}}}t.drawImage(this.obstacleCanvas,u,g)}e.zone.currentRadius<Math.max(i,n)&&(t.save(),t.beginPath(),t.rect(u,g,d,d),t.clip(),t.fillStyle="rgba(255,0,0,0.3)",t.fillRect(u,g,d,d),t.globalCompositeOperation="destination-out",t.beginPath(),t.arc(u+e.zone.centerX*a,g+e.zone.centerY*y,e.zone.currentRadius*Math.min(a,y),0,Math.PI*2),t.fill(),t.globalCompositeOperation="source-over",t.restore());const b=Math.round(3*l),v=Math.round(5*l);for(const S of e.tanks){if(!S.isAlive)continue;const k=u+S.position.x*a,T=g+S.position.y*y;S.id===r?(t.fillStyle="#FFF",t.fillRect(k-v/2,T-v/2,v,v)):S.isBot?(t.fillStyle="#FF4444",t.fillRect(k-b/2,T-b/2,b,b)):(t.fillStyle="#44FF44",t.fillRect(k-b/2,T-b/2,b,b))}for(const S of e.stars){if(!S.active)continue;const k=u+S.position.x*a,T=g+S.position.y*y;t.fillStyle="#FFD700",t.fillRect(k,T,Math.round(2*l),Math.round(2*l))}for(const S of e.portals){const k=u+S.position.x*a,T=g+S.position.y*y;t.fillStyle="#00FFFF",t.beginPath(),t.arc(k,T,Math.round(3*l),0,Math.PI*2),t.fill()}t.strokeStyle="#FFF",t.lineWidth=1,t.strokeRect(u+s.x*a,g+s.y*y,s.viewportW*a,s.viewportH*y)}}class ns{render(t,e,s,i){const n=Math.max(e.centerX,e.centerY)*2;if(e.currentRadius>=n)return;const{sx:r,sy:h}=s.worldToScreen(e.centerX,e.centerY,i),l=e.currentRadius*i;t.save(),t.fillStyle="rgba(255, 0, 0, 0.15)",t.beginPath(),t.rect(0,0,t.canvas.width,t.canvas.height),t.arc(r,h,l,0,Math.PI*2,!0),t.fill(),t.strokeStyle="rgba(255, 0, 0, 0.6)",t.lineWidth=2,t.setLineDash([10,5]),t.beginPath(),t.arc(r,h,l,0,Math.PI*2),t.stroke(),t.setLineDash([]),t.restore()}}class os{constructor(){m(this,"explosions",[]);m(this,"bulletImpacts",[]);m(this,"muzzleFlashes",[]);m(this,"smokeParticles",[]);m(this,"tankTrails",[]);m(this,"brickDebris",[]);m(this,"starCollects",[]);m(this,"fadeStartTime",0);m(this,"fadeColor",null);m(this,"fadeDuration",Ye);m(this,"shakeIntensity",0);m(this,"shakeDecay",.88);m(this,"shakeOffsetX",0);m(this,"shakeOffsetY",0);m(this,"recoilAngle",0);m(this,"recoilMagnitude",0);m(this,"recoilOffsetX",0);m(this,"recoilOffsetY",0)}addExplosion(t,e){const s=[];for(let n=0;n<20;n++){const r=Math.PI*2*n/20+(Math.random()-.5)*.5;s.push({angle:r,speed:.15+Math.random()*.15,size:.1+Math.random()*.15,color:n%3===0?"#FFD700":n%3===1?"#FF6600":"#FF3300"})}this.explosions.push({x:t,y:e,startTime:Date.now(),duration:800,particles:s}),this.addScreenShake(6);for(let n=0;n<8;n++){const r=Math.random()*Math.PI*2,h=.02+Math.random()*.03;this.smokeParticles.push({x:t+(Math.random()-.5)*.3,y:e+(Math.random()-.5)*.3,vx:Math.cos(r)*h,vy:Math.sin(r)*h-.02,startTime:Date.now()+Math.random()*200,duration:1200,size:.3+Math.random()*.3})}}addBulletImpact(t,e,s=!1){this.bulletImpacts.push({x:t,y:e,startTime:Date.now(),duration:300}),this.addScreenShake(2),s&&this.addBrickDebris(t,e);for(let i=0;i<3;i++){const n=Math.random()*Math.PI*2,r=.01+Math.random()*.02;this.smokeParticles.push({x:t+(Math.random()-.5)*.1,y:e+(Math.random()-.5)*.1,vx:Math.cos(n)*r,vy:Math.sin(n)*r-.01,startTime:Date.now(),duration:500,size:.1+Math.random()*.1})}}addMuzzleFlash(t,e,s){this.muzzleFlashes.push({x:t,y:e,angle:s,startTime:Date.now(),duration:80});for(let i=0;i<2;i++){const n=(Math.random()-.5)*.3;this.smokeParticles.push({x:t+Math.sin(s)*.5,y:e-Math.cos(s)*.5,vx:Math.sin(s+n)*.04,vy:-Math.cos(s+n)*.04-.01,startTime:Date.now(),duration:600,size:.15+Math.random()*.1})}}addTankTrail(t,e,s){Math.random()>.3||(this.tankTrails.push({x:t,y:e,angle:s,startTime:Date.now(),duration:2e3}),this.tankTrails.length>100&&this.tankTrails.shift())}addBrickDebris(t,e){const s=[];for(let i=0;i<8;i++)s.push({angle:Math.random()*Math.PI*2,speed:.05+Math.random()*.1,size:.05+Math.random()*.08,rotSpeed:(Math.random()-.5)*10});this.brickDebris.push({x:t,y:e,startTime:Date.now(),duration:600,particles:s}),this.brickDebris.length>30&&this.brickDebris.shift()}addStarCollect(t,e){this.starCollects.push({x:t,y:e,startTime:Date.now(),duration:800}),this.starCollects.length>20&&this.starCollects.shift()}addScreenShake(t){}triggerRecoil(t){this.recoilAngle=t,this.recoilMagnitude=.12}startFade(t){this.fadeStartTime=Date.now(),this.fadeColor=t}get isFading(){return this.fadeColor!==null&&Date.now()-this.fadeStartTime<this.fadeDuration}get fadeComplete(){return this.fadeColor!==null&&Date.now()-this.fadeStartTime>=this.fadeDuration}updateShake(){this.shakeIntensity>.1?(this.shakeOffsetX=(Math.random()-.5)*2*this.shakeIntensity,this.shakeOffsetY=(Math.random()-.5)*2*this.shakeIntensity,this.shakeIntensity*=this.shakeDecay):(this.shakeIntensity=0,this.shakeOffsetX=0,this.shakeOffsetY=0),this.recoilMagnitude>.005?(this.recoilOffsetX=Math.sin(this.recoilAngle)*this.recoilMagnitude,this.recoilOffsetY=-Math.cos(this.recoilAngle)*this.recoilMagnitude,this.recoilMagnitude*=.75):(this.recoilMagnitude=0,this.recoilOffsetX=0,this.recoilOffsetY=0)}renderExplosions(t,e,s){const i=Date.now();this.explosions=this.explosions.filter(n=>i-n.startTime<n.duration);for(const n of this.explosions){const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2;for(let f=0;f<3;f++){const p=f*.1,u=Math.max(0,Math.min(1,(r-p)/(1-p)));if(u<=0)continue;const a=s*(1.8-f*.3)*u,y=(1-u)*.6,b=t.createRadialGradient(d,c,0,d,c,a);b.addColorStop(0,`rgba(255, 220, 100, ${y})`),b.addColorStop(.4,`rgba(255, 120, 30, ${y*.7})`),b.addColorStop(.7,`rgba(255, 50, 0, ${y*.4})`),b.addColorStop(1,"rgba(100, 0, 0, 0)"),t.fillStyle=b,t.beginPath(),t.arc(d,c,a,0,Math.PI*2),t.fill()}for(const f of n.particles){const p=Math.min(1,r*1.5),u=f.speed*s*3*p,g=d+Math.cos(f.angle)*u,a=c+Math.sin(f.angle)*u+s*.5*p*p,y=(1-p)*.9,b=f.size*s*(1-p*.5);t.shadowBlur=8,t.shadowColor=f.color;const v=(S,k)=>{const T=parseInt(S.slice(1),16),F=T>>16&255,E=T>>8&255,M=T&255;return`rgba(${F}, ${E}, ${M}, ${k})`};t.fillStyle=v(f.color,y),t.beginPath(),t.arc(g,a,b,0,Math.PI*2),t.fill(),t.shadowBlur=0}if(r<.3){const f=r/.3,p=(1-f)*.8,u=s*.8*(1+f);t.fillStyle=`rgba(255, 255, 255, ${p})`,t.beginPath(),t.arc(d,c,u,0,Math.PI*2),t.fill()}}}renderBulletImpacts(t,e,s){const i=Date.now();this.bulletImpacts=this.bulletImpacts.filter(n=>i-n.startTime<n.duration);for(const n of this.bulletImpacts){const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2,f=s*.4*(1+r),p=(1-r)*.8,u=t.createRadialGradient(d,c,0,d,c,f);if(u.addColorStop(0,`rgba(255, 220, 100, ${p})`),u.addColorStop(.4,`rgba(255, 140, 20, ${p*.5})`),u.addColorStop(1,"rgba(255, 80, 0, 0)"),t.fillStyle=u,t.beginPath(),t.arc(d,c,f,0,Math.PI*2),t.fill(),r<.6){const a=(1-r/.6)*.9;t.fillStyle=`rgba(255, 200, 50, ${a})`;for(let y=0;y<6;y++){const b=y/6*Math.PI*2+r*4,v=s*.15+s*.5*r,S=d+Math.cos(b)*v,k=c+Math.sin(b)*v,T=2*(1-r/.6);t.beginPath(),t.arc(S,k,T,0,Math.PI*2),t.fill()}}}}renderBrickDebris(t,e,s){const i=Date.now();this.brickDebris=this.brickDebris.filter(n=>i-n.startTime<n.duration);for(const n of this.brickDebris){const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2;for(const f of n.particles){const p=f.speed*s*4*r,u=d+Math.cos(f.angle)*p,g=c+Math.sin(f.angle)*p+s*.3*r*r,a=(1-r)*.9,y=f.size*s*(1-r*.3);t.save(),t.translate(u,g),t.rotate(f.rotSpeed*r),t.fillStyle=`rgba(180, 75, 40, ${a})`,t.fillRect(-y/2,-y/2,y,y),t.fillStyle=`rgba(220, 120, 70, ${a*.6})`,t.fillRect(-y/2,-y/2,y*.4,y*.4),t.restore()}}}renderStarCollects(t,e,s){const i=Date.now();this.starCollects=this.starCollects.filter(n=>i-n.startTime<n.duration);for(const n of this.starCollects){const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2,f=c-r*s*1.5,p=r<.3?r/.3:1-(r-.3)/.7;if(t.fillStyle=`rgba(255, 215, 0, ${p})`,t.font=`bold ${s*.5}px Arial`,t.textAlign="center",t.textBaseline="middle",t.shadowColor="#FFD700",t.shadowBlur=10,t.fillText("+1",d,f),t.shadowBlur=0,r<.5){const u=r/.5,g=s*.5*(1+u),a=(1-u)*.7,y=8;for(let b=0;b<y;b++){const v=b/y*Math.PI*2+r*6,S=d+Math.cos(v)*g,k=c+Math.sin(v)*g;t.fillStyle=`rgba(255, 255, 200, ${a})`,t.beginPath(),t.arc(S,k,2*(1-u),0,Math.PI*2),t.fill()}}if(r<.2){const u=(1-r/.2)*.5,g=s*.8*(1+r*3),a=t.createRadialGradient(d,c,0,d,c,g);a.addColorStop(0,`rgba(255, 215, 0, ${u})`),a.addColorStop(1,"rgba(255, 215, 0, 0)"),t.fillStyle=a,t.beginPath(),t.arc(d,c,g,0,Math.PI*2),t.fill()}}}renderPortals(t,e,s,i){const n=Date.now();for(const r of e){if(!s.isVisible(r.position.x,r.position.y))continue;const{sx:h,sy:l}=s.worldToScreen(r.position.x,r.position.y,i),d=h+i/2,c=l+i/2,f=n/500,p=.8+Math.sin(n/300)*.2,u=i*.45*p;t.save(),t.translate(d,c),t.rotate(f),t.strokeStyle="#00FFFF",t.lineWidth=2,t.beginPath(),t.arc(0,0,u,0,Math.PI*2),t.stroke();const g=t.createRadialGradient(0,0,0,0,0,u);g.addColorStop(0,"rgba(0, 255, 255, 0.4)"),g.addColorStop(1,"rgba(0, 100, 255, 0.1)"),t.fillStyle=g,t.beginPath(),t.arc(0,0,u,0,Math.PI*2),t.fill(),t.strokeStyle="rgba(0, 255, 255, 0.5)",t.lineWidth=1;for(let a=0;a<3;a++){t.beginPath();const y=a*Math.PI*2/3;for(let b=0;b<1;b+=.05){const v=u*b,S=y+b*Math.PI*2,k=v*Math.cos(S),T=v*Math.sin(S);b===0?t.moveTo(k,T):t.lineTo(k,T)}t.stroke()}t.restore()}}renderMuzzleFlashes(t,e,s){const i=Date.now();this.muzzleFlashes=this.muzzleFlashes.filter(n=>i-n.startTime<n.duration);for(const n of this.muzzleFlashes){const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2;t.save(),t.translate(d,c),t.rotate(n.angle);const f=s*.6*(1-r),p=s*.4*(1-r),u=(1-r)*.9,g=t.createLinearGradient(0,0,0,f);g.addColorStop(0,`rgba(255, 255, 200, ${u})`),g.addColorStop(.5,`rgba(255, 200, 50, ${u*.7})`),g.addColorStop(1,"rgba(255, 100, 0, 0)"),t.fillStyle=g,t.beginPath(),t.moveTo(0,0),t.lineTo(-p/2,f),t.lineTo(p/2,f),t.closePath(),t.fill(),t.shadowBlur=10,t.shadowColor="#FFFF00",t.fillStyle=`rgba(255, 255, 255, ${u})`,t.beginPath(),t.arc(0,0,s*.15*(1-r*.5),0,Math.PI*2),t.fill(),t.shadowBlur=0,t.restore()}}renderSmokeParticles(t,e,s){const i=Date.now();this.smokeParticles=this.smokeParticles.filter(n=>i-n.startTime<n.duration);for(const n of this.smokeParticles){if(i<n.startTime)continue;const r=(i-n.startTime)/n.duration,h=n.x+n.vx*(i-n.startTime)/16.67,l=n.y+n.vy*(i-n.startTime)/16.67;if(!e.isVisible(h,l))continue;const{sx:d,sy:c}=e.worldToScreen(h,l,s),f=d+s/2,p=c+s/2,u=n.size*s*(1+r*.5),g=(1-r)*.4,a=t.createRadialGradient(f,p,0,f,p,u);a.addColorStop(0,`rgba(80, 80, 80, ${g})`),a.addColorStop(.5,`rgba(60, 60, 60, ${g*.6})`),a.addColorStop(1,"rgba(40, 40, 40, 0)"),t.fillStyle=a,t.beginPath(),t.arc(f,p,u,0,Math.PI*2),t.fill()}}renderTankTrails(t,e,s){const i=Date.now();this.tankTrails=this.tankTrails.filter(n=>i-n.startTime<n.duration);for(const n of this.tankTrails){if(!e.isVisible(n.x,n.y))continue;const r=(i-n.startTime)/n.duration,{sx:h,sy:l}=e.worldToScreen(n.x,n.y,s),d=h+s/2,c=l+s/2,f=(1-r)*.15;t.save(),t.translate(d,c),t.rotate(n.angle);const p=s*.15,u=s*.25;for(const g of[-1,1]){t.fillStyle=`rgba(50, 50, 50, ${f})`,t.fillRect(-p/2+g*u,-s*.15,p,s*.3),t.strokeStyle=`rgba(40, 40, 40, ${f})`,t.lineWidth=1;for(let a=0;a<3;a++){const y=-s*.1+a*s*.1;t.beginPath(),t.moveTo(-p/2+g*u,y),t.lineTo(p/2+g*u,y),t.stroke()}}t.restore()}}renderFade(t){if(!this.fadeColor)return;const e=Date.now()-this.fadeStartTime,s=Math.min(1,e/this.fadeDuration);t.fillStyle=this.fadeColor==="white"?`rgba(255, 255, 255, ${s})`:`rgba(0, 0, 0, ${s})`,t.fillRect(0,0,t.canvas.width,t.canvas.height)}renderPortalArrow(t,e,s,i,n){const r=n??i,h=s.x-e.x,l=s.y-e.y,d=Math.atan2(l,h),c=i/2-30,f=r/2-30,p=Math.min(c,f),u=i/2+Math.cos(d)*p,g=r/2+Math.sin(d)*p;t.save(),t.translate(u,g),t.rotate(d),t.fillStyle="#00FFFF",t.beginPath(),t.moveTo(12,0),t.lineTo(-6,-8),t.lineTo(-6,8),t.closePath(),t.fill(),t.restore()}reset(){this.explosions=[],this.bulletImpacts=[],this.muzzleFlashes=[],this.smokeParticles=[],this.tankTrails=[],this.brickDebris=[],this.starCollects=[],this.fadeColor=null,this.shakeIntensity=0,this.shakeOffsetX=0,this.shakeOffsetY=0,this.recoilMagnitude=0,this.recoilOffsetX=0,this.recoilOffsetY=0}}class rs{constructor(t){m(this,"ctx");m(this,"canvas");m(this,"mapRenderer",new Ve);m(this,"tankRenderer",new Qe);m(this,"bulletRenderer",new Ze);m(this,"hudRenderer",new xe);m(this,"minimapRenderer",new is);m(this,"zoneRenderer",new ns);m(this,"effects",new os);m(this,"cellPx",24);m(this,"mapLoaded",!1);m(this,"isMobile","ontouchstart"in window);m(this,"prevBulletIds",new Set);m(this,"prevTankPositions",new Map);m(this,"prevBullets",new Map);m(this,"prevActiveStars",new Set);m(this,"processedDestroyedObstacles",new Set);this.canvas=t,this.ctx=t.getContext("2d"),this.hudRenderer.isMobile=this.isMobile,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;const t=this.isMobile?Math.min(vt,18):vt;this.cellPx=Math.min(window.innerWidth,window.innerHeight)/t}setCustomTankColors(t){this.tankRenderer.customColors=t}loadMap(t){this.mapRenderer.loadObstacles(t.obstacles),this.mapLoaded=!0}render(t){const{ctx:e,cellPx:s}=this,{state:i,camera:n,playerId:r,mapWidth:h,mapHeight:l}=t;if(!i||!this.mapLoaded){this.renderLoading();return}n.setViewport(this.canvas.width,this.canvas.height,s),this.detectBulletImpacts(i.bullets);for(const a of i.bullets)if(!this.prevBullets.has(a.id)){const y=i.tanks.find(b=>b.id===a.ownerId);if(y&&y.isAlive){const b=y.tankRadius*1.2,v=y.position.x+Math.sin(y.turretAngle)*b,S=y.position.y-Math.cos(y.turretAngle)*b;this.effects.addMuzzleFlash(v,S,y.turretAngle)}}if(this.prevBullets=new Map(i.bullets.map(a=>[a.id,a])),this.effects.updateShake(),e.save(),e.translate(this.effects.shakeOffsetX,this.effects.shakeOffsetY),this.mapRenderer.render(e,n,s),i.destroyedObstacles)for(const a of i.destroyedObstacles){const y=`${a.x},${a.y}`;this.processedDestroyedObstacles.has(y)||(this.processedDestroyedObstacles.add(y),this.mapRenderer.removeObstacle(a.x,a.y),this.effects.addBrickDebris(a.x+.5,a.y+.5),this.effects.addBulletImpact(a.x+.5,a.y+.5,!0))}this.zoneRenderer.render(e,i.zone,n,s),i.ctf&&this.renderCTF(e,i.ctf,n,s),this.effects.renderTankTrails(e,n,s);const d=new Set;for(const a of i.stars)a.active?(d.add(a.id),!this.prevActiveStars.has(a.id)&&this.prevActiveStars.size>0):this.prevActiveStars.has(a.id)&&this.effects.addStarCollect(a.position.x,a.position.y);this.prevActiveStars=d,this.renderStars(e,i,n,s),this.renderPowerUps(e,i,n,s),this.effects.renderPortals(e,i.portals,n,s),this.bulletRenderer.render(e,i.bullets,n,s),this.effects.renderBulletImpacts(e,n,s),this.effects.renderBrickDebris(e,n,s),this.effects.renderSmokeParticles(e,n,s),this.effects.renderStarCollects(e,n,s);const c=i.tanks.map(a=>{if(a.id===r){const y=t.getMyDisplayPosition();if(y){const b={x:y.x-this.effects.recoilOffsetX,y:y.y-this.effects.recoilOffsetY};return{...a,position:b,hullAngle:t.getMyDisplayHullAngle(),turretAngle:t.getMyDisplayTurretAngle()}}}return a});for(const a of c){if(!a.isAlive)continue;const y=this.prevTankPositions.get(a.id);if(y){const b=a.position.x-y.x,v=a.position.y-y.y;Math.sqrt(b*b+v*v)>.02&&this.effects.addTankTrail(a.position.x,a.position.y,a.hullAngle)}this.prevTankPositions.set(a.id,{x:a.position.x,y:a.position.y})}const f=i.tanks.find(a=>a.id===r),p=c.filter(a=>{if(a.id===r||!a.inBush)return!0;if(f){const y=a.position.x-f.position.x,b=a.position.y-f.position.y,v=y*y+b*b,S=3;return v<=S*S}return!1});this.renderOpticalSights(e,p,n,s),this.tankRenderer.render(e,p,n,s,r),this.mapRenderer.renderBushes(e,n,s),this.effects.renderMuzzleFlashes(e,n,s),this.effects.renderExplosions(e,n,s);const u=t.getMyTank(),g=t.getMyDisplayPosition();if(u&&g){const{sx:a,sy:y}=n.worldToScreen(g.x,g.y,s),b=a+s/2;if(e.fillStyle="#FFF",e.beginPath(),e.moveTo(b,y-s*.6),e.lineTo(b-4,y-s*.4),e.lineTo(b+4,y-s*.4),e.fill(),i.portals.length>0){let v=i.portals[0],S=1/0;for(const k of i.portals){const T=k.position.x-g.x,F=k.position.y-g.y,E=T*T+F*F;E<S&&(S=E,v=k)}this.effects.renderPortalArrow(e,g,v.position,this.canvas.width,this.canvas.height)}}e.restore(),this.hudRenderer.render(e,i,u),this.minimapRenderer.render(e,i,n,h,l,r,t.obstacles),this.effects.renderFade(e)}detectBulletImpacts(t){const e=new Set(t.map(s=>s.id));this.prevBulletIds=e}renderStars(t,e,s,i){const n=Date.now()/1e3;for(const r of e.stars){if(!r.active||!s.isVisible(r.position.x,r.position.y))continue;const{sx:h,sy:l}=s.worldToScreen(r.position.x,r.position.y,i),d=h+i/2,c=l+i/2,f=i*.32;t.fillStyle="rgba(0, 0, 0, 0.2)",t.beginPath(),t.arc(d+2,c+2,f*.8,0,Math.PI*2),t.fill(),t.shadowColor="#FFD700",t.shadowBlur=15,t.fillStyle="rgba(255, 215, 0, 0.3)",t.beginPath(),t.arc(d,c,f*1.5,0,Math.PI*2),t.fill();const p=n*.5;t.save(),t.translate(d,c),t.rotate(p);const u=t.createRadialGradient(0,0,0,0,0,f);u.addColorStop(0,"#FFFFD0"),u.addColorStop(.4,"#FFD700"),u.addColorStop(.7,"#FFB700"),u.addColorStop(1,"#CC9900"),t.fillStyle=u,t.shadowBlur=8,t.beginPath();for(let a=0;a<5;a++){const y=a*4*Math.PI/5-Math.PI/2,b=f,v=f*.4,S=y,k=y+Math.PI/5;a===0?t.moveTo(b*Math.cos(S),b*Math.sin(S)):t.lineTo(b*Math.cos(S),b*Math.sin(S)),t.lineTo(v*Math.cos(k),v*Math.sin(k))}t.closePath(),t.fill(),t.fillStyle="#FFFFFF",t.shadowBlur=4,t.beginPath(),t.arc(0,0,f*.3,0,Math.PI*2),t.fill();const g=Math.sin(n*3+r.position.x+r.position.y)*.5+.5;t.fillStyle=`rgba(255, 255, 255, ${g})`,t.shadowBlur=2,t.beginPath(),t.arc(-f*.15,-f*.15,f*.15,0,Math.PI*2),t.fill(),t.restore(),t.shadowBlur=0}}renderPowerUps(t,e,s,i){const n={rapidFire:"#FF4444",speed:"#44FF44",shield:"#4488FF",magnet:"#FFD700",heal:"#FF66FF",opticalSight:"#FF2222",rocket:"#FF6600"};for(const r of e.powerUps){if(!s.isVisible(r.position.x,r.position.y))continue;const{sx:h,sy:l}=s.worldToScreen(r.position.x,r.position.y,i),d=h+i/2,c=l+i/2,f=.8+Math.sin(Date.now()/200)*.2,p=i*.4*f;t.shadowBlur=10,t.shadowColor=n[r.type]??"#FFF",t.fillStyle=n[r.type]??"#FFF",t.globalAlpha=.3,t.beginPath(),t.arc(d,c,p,0,Math.PI*2),t.fill(),t.globalAlpha=1,t.shadowBlur=0,t.strokeStyle=n[r.type]??"#FFF",t.fillStyle=n[r.type]??"#FFF",t.lineWidth=2,t.lineCap="round",t.lineJoin="round";const u=p*.6;switch(r.type){case"rapidFire":for(let g=-1;g<=1;g++)t.fillRect(d+g*u*.4-u*.1,c-u*.6,u*.2,u*1.2);break;case"speed":t.beginPath(),t.moveTo(d+u*.2,c-u*.8),t.lineTo(d-u*.3,c),t.lineTo(d+u*.1,c),t.lineTo(d-u*.2,c+u*.8),t.lineTo(d+u*.3,c-.2),t.lineTo(d-u*.1,c-.2),t.closePath(),t.fill();break;case"shield":t.beginPath(),t.moveTo(d,c-u*.8),t.lineTo(d+u*.6,c-u*.4),t.lineTo(d+u*.6,c+u*.2),t.quadraticCurveTo(d+u*.6,c+u*.7,d,c+u*.9),t.quadraticCurveTo(d-u*.6,c+u*.7,d-u*.6,c+u*.2),t.lineTo(d-u*.6,c-u*.4),t.closePath(),t.fill(),t.strokeStyle="#FFF",t.lineWidth=2,t.beginPath(),t.moveTo(d,c-u*.4),t.lineTo(d,c+u*.4),t.moveTo(d-u*.3,c),t.lineTo(d+u*.3,c),t.stroke();break;case"magnet":t.beginPath(),t.arc(d,c,u*.6,Math.PI,0,!1),t.lineWidth=u*.3,t.stroke(),t.fillStyle="#FF4444",t.fillRect(d-u*.65,c-u*.15,u*.25,u*.5),t.fillStyle="#4444FF",t.fillRect(d+u*.4,c-u*.15,u*.25,u*.5);break;case"heal":{t.fillStyle=n[r.type]??"#FFF";const g=u*.3,a=u*.9;t.fillRect(d-g/2,c-a/2,g,a),t.fillRect(d-a/2,c-g/2,a,g);break}case"opticalSight":t.strokeStyle="#FF2222",t.lineWidth=2,t.beginPath(),t.arc(d,c,u*.5,0,Math.PI*2),t.stroke(),t.beginPath(),t.moveTo(d-u*.8,c),t.lineTo(d+u*.8,c),t.moveTo(d,c-u*.8),t.lineTo(d,c+u*.8),t.stroke(),t.fillStyle="#FF2222",t.beginPath(),t.arc(d,c,u*.1,0,Math.PI*2),t.fill();break;case"rocket":t.fillStyle="#FF6600",t.save(),t.translate(d,c),t.beginPath(),t.ellipse(0,0,u*.25,u*.7,0,0,Math.PI*2),t.fill(),t.fillStyle="#FF4400",t.beginPath(),t.moveTo(-u*.2,-u*.6),t.lineTo(0,-u*.95),t.lineTo(u*.2,-u*.6),t.closePath(),t.fill(),t.fillStyle="#CC3300",t.beginPath(),t.moveTo(-u*.2,u*.5),t.lineTo(-u*.5,u*.8),t.lineTo(-u*.15,u*.3),t.closePath(),t.fill(),t.beginPath(),t.moveTo(u*.2,u*.5),t.lineTo(u*.5,u*.8),t.lineTo(u*.15,u*.3),t.closePath(),t.fill(),t.fillStyle="rgba(255,200,50,0.7)",t.beginPath(),t.arc(0,u*.7,u*.15,0,Math.PI*2),t.fill(),t.restore();break}t.strokeStyle="#FFF",t.lineWidth=2,t.globalAlpha=.8,t.beginPath(),t.arc(d,c,p,0,Math.PI*2),t.stroke(),t.globalAlpha=1}}renderOpticalSights(t,e,s,i){for(const n of e){if(!n.isAlive||n.activePowerUp!==G.OpticalSight||!s.isVisible(n.position.x,n.position.y))continue;const{sx:r,sy:h}=s.worldToScreen(n.position.x,n.position.y,i),l=r+i/2,d=h+i/2,c=n.tankRadius*1.2*i,f=We*i,p=l+Math.sin(n.turretAngle)*c,u=d-Math.cos(n.turretAngle)*c,g=l+Math.sin(n.turretAngle)*f,a=d-Math.cos(n.turretAngle)*f;t.save(),t.strokeStyle="rgba(255, 0, 0, 0.15)",t.lineWidth=4,t.beginPath(),t.moveTo(p,u),t.lineTo(g,a),t.stroke(),t.strokeStyle="rgba(255, 30, 30, 0.7)",t.lineWidth=1,t.beginPath(),t.moveTo(p,u),t.lineTo(g,a),t.stroke(),t.fillStyle="rgba(255, 0, 0, 0.5)",t.beginPath(),t.arc(g,a,3,0,Math.PI*2),t.fill(),t.restore()}}renderLoading(){const{ctx:t,canvas:e}=this;t.fillStyle="#1a1a2e",t.fillRect(0,0,e.width,e.height),t.fillStyle="#FFD700",t.font=`bold ${e.width/14}px Arial`,t.textAlign="center",t.textBaseline="middle",t.fillText("TANK BATTLE ROYALE",e.width/2,e.height/3),t.fillStyle="#888",t.font=`${e.width/30}px Arial`,t.fillText("Connecting...",e.width/2,e.height/2)}renderCTF(t,e,s,i){t.save(),t.setLineDash([i*.3,i*.2]),t.lineWidth=2,t.strokeStyle="rgba(68, 136, 255, 0.6)",t.strokeRect((e.baseA.x-s.x)*i,(e.baseA.y-s.y)*i,e.baseA.w*i,e.baseA.h*i),t.fillStyle="rgba(68, 136, 255, 0.05)",t.fillRect((e.baseA.x-s.x)*i,(e.baseA.y-s.y)*i,e.baseA.w*i,e.baseA.h*i),t.strokeStyle="rgba(255, 68, 68, 0.6)",t.strokeRect((e.baseB.x-s.x)*i,(e.baseB.y-s.y)*i,e.baseB.w*i,e.baseB.h*i),t.fillStyle="rgba(255, 68, 68, 0.05)",t.fillRect((e.baseB.x-s.x)*i,(e.baseB.y-s.y)*i,e.baseB.w*i,e.baseB.h*i),t.setLineDash([]),t.restore(),e.flagACarrier||this.renderFlag(t,e.flagA,s,i,"#4488FF",e.flagADropped),e.flagBCarrier||this.renderFlag(t,e.flagB,s,i,"#FF4444",e.flagBDropped)}renderFlag(t,e,s,i,n,r){const h=(e.x-s.x)*i,l=(e.y-s.y)*i,d=i*.8;if(t.strokeStyle="#AAA",t.lineWidth=2,t.beginPath(),t.moveTo(h,l+d*.5),t.lineTo(h,l-d*.5),t.stroke(),t.fillStyle=n,t.globalAlpha=r?.7:1,t.beginPath(),t.moveTo(h,l-d*.5),t.lineTo(h+d*.6,l-d*.25),t.lineTo(h,l),t.closePath(),t.fill(),t.globalAlpha=1,r){const c=.3+.2*Math.sin(Date.now()/300);t.fillStyle=n,t.globalAlpha=c,t.beginPath(),t.arc(h,l,d*.6,0,Math.PI*2),t.fill(),t.globalAlpha=1}}get currentCellPx(){return this.cellPx}setShopOpen(t){this.hudRenderer.shopOpen=t}setStuckHint(t,e){this.hudRenderer.showStuckHint=t,this.hudRenderer.unstickCooldownMs=e}hitTestStuckButton(t,e){const s=this.hudRenderer.stuckButtonRect;return s?t>=s.x&&t<=s.x+s.w&&e>=s.y&&e<=s.y+s.h:!1}}const J=Object.create(null);J.open="0";J.close="1";J.ping="2";J.pong="3";J.message="4";J.upgrade="5";J.noop="6";const mt=Object.create(null);Object.keys(J).forEach(o=>{mt[J[o]]=o});const Lt={type:"error",data:"parser error"},ye=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",me=typeof ArrayBuffer=="function",be=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o&&o.buffer instanceof ArrayBuffer,Xt=({type:o,data:t},e,s)=>ye&&t instanceof Blob?e?s(t):Zt(t,s):me&&(t instanceof ArrayBuffer||be(t))?e?s(t):Zt(new Blob([t]),s):s(J[o]+(t||"")),Zt=(o,t)=>{const e=new FileReader;return e.onload=function(){const s=e.result.split(",")[1];t("b"+(s||""))},e.readAsDataURL(o)};function xt(o){return o instanceof Uint8Array?o:o instanceof ArrayBuffer?new Uint8Array(o):new Uint8Array(o.buffer,o.byteOffset,o.byteLength)}let Ft;function as(o,t){if(ye&&o.data instanceof Blob)return o.data.arrayBuffer().then(xt).then(t);if(me&&(o.data instanceof ArrayBuffer||be(o.data)))return t(xt(o.data));Xt(o,!1,e=>{Ft||(Ft=new TextEncoder),t(Ft.encode(e))})}const te="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ht=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let o=0;o<te.length;o++)ht[te.charCodeAt(o)]=o;const ls=o=>{let t=o.length*.75,e=o.length,s,i=0,n,r,h,l;o[o.length-1]==="="&&(t--,o[o.length-2]==="="&&t--);const d=new ArrayBuffer(t),c=new Uint8Array(d);for(s=0;s<e;s+=4)n=ht[o.charCodeAt(s)],r=ht[o.charCodeAt(s+1)],h=ht[o.charCodeAt(s+2)],l=ht[o.charCodeAt(s+3)],c[i++]=n<<2|r>>4,c[i++]=(r&15)<<4|h>>2,c[i++]=(h&3)<<6|l&63;return d},hs=typeof ArrayBuffer=="function",qt=(o,t)=>{if(typeof o!="string")return{type:"message",data:Se(o,t)};const e=o.charAt(0);return e==="b"?{type:"message",data:ds(o.substring(1),t)}:mt[e]?o.length>1?{type:mt[e],data:o.substring(1)}:{type:mt[e]}:Lt},ds=(o,t)=>{if(hs){const e=ls(o);return Se(e,t)}else return{base64:!0,data:o}},Se=(o,t)=>{switch(t){case"blob":return o instanceof Blob?o:new Blob([o]);case"arraybuffer":default:return o instanceof ArrayBuffer?o:o.buffer}},we="",cs=(o,t)=>{const e=o.length,s=new Array(e);let i=0;o.forEach((n,r)=>{Xt(n,!1,h=>{s[r]=h,++i===e&&t(s.join(we))})})},fs=(o,t)=>{const e=o.split(we),s=[];for(let i=0;i<e.length;i++){const n=qt(e[i],t);if(s.push(n),n.type==="error")break}return s};function us(){return new TransformStream({transform(o,t){as(o,e=>{const s=e.length;let i;if(s<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,s);else if(s<65536){i=new Uint8Array(3);const n=new DataView(i.buffer);n.setUint8(0,126),n.setUint16(1,s)}else{i=new Uint8Array(9);const n=new DataView(i.buffer);n.setUint8(0,127),n.setBigUint64(1,BigInt(s))}o.data&&typeof o.data!="string"&&(i[0]|=128),t.enqueue(i),t.enqueue(e)})}})}let Et;function ft(o){return o.reduce((t,e)=>t+e.length,0)}function ut(o,t){if(o[0].length===t)return o.shift();const e=new Uint8Array(t);let s=0;for(let i=0;i<t;i++)e[i]=o[0][s++],s===o[0].length&&(o.shift(),s=0);return o.length&&s<o[0].length&&(o[0]=o[0].slice(s)),e}function ps(o,t){Et||(Et=new TextDecoder);const e=[];let s=0,i=-1,n=!1;return new TransformStream({transform(r,h){for(e.push(r);;){if(s===0){if(ft(e)<1)break;const l=ut(e,1);n=(l[0]&128)===128,i=l[0]&127,i<126?s=3:i===126?s=1:s=2}else if(s===1){if(ft(e)<2)break;const l=ut(e,2);i=new DataView(l.buffer,l.byteOffset,l.length).getUint16(0),s=3}else if(s===2){if(ft(e)<8)break;const l=ut(e,8),d=new DataView(l.buffer,l.byteOffset,l.length),c=d.getUint32(0);if(c>Math.pow(2,21)-1){h.enqueue(Lt);break}i=c*Math.pow(2,32)+d.getUint32(4),s=3}else{if(ft(e)<i)break;const l=ut(e,i);h.enqueue(qt(n?l:Et.decode(l),t)),s=0}if(i===0||i>o){h.enqueue(Lt);break}}}})}const ve=4;function P(o){if(o)return gs(o)}function gs(o){for(var t in P.prototype)o[t]=P.prototype[t];return o}P.prototype.on=P.prototype.addEventListener=function(o,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+o]=this._callbacks["$"+o]||[]).push(t),this};P.prototype.once=function(o,t){function e(){this.off(o,e),t.apply(this,arguments)}return e.fn=t,this.on(o,e),this};P.prototype.off=P.prototype.removeListener=P.prototype.removeAllListeners=P.prototype.removeEventListener=function(o,t){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+o];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+o],this;for(var s,i=0;i<e.length;i++)if(s=e[i],s===t||s.fn===t){e.splice(i,1);break}return e.length===0&&delete this._callbacks["$"+o],this};P.prototype.emit=function(o){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),e=this._callbacks["$"+o],s=1;s<arguments.length;s++)t[s-1]=arguments[s];if(e){e=e.slice(0);for(var s=0,i=e.length;s<i;++s)e[s].apply(this,t)}return this};P.prototype.emitReserved=P.prototype.emit;P.prototype.listeners=function(o){return this._callbacks=this._callbacks||{},this._callbacks["$"+o]||[]};P.prototype.hasListeners=function(o){return!!this.listeners(o).length};const Mt=typeof Promise=="function"&&typeof Promise.resolve=="function"?t=>Promise.resolve().then(t):(t,e)=>e(t,0),q=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),ys="arraybuffer";function ke(o,...t){return t.reduce((e,s)=>(o.hasOwnProperty(s)&&(e[s]=o[s]),e),{})}const ms=q.setTimeout,bs=q.clearTimeout;function Tt(o,t){t.useNativeTimers?(o.setTimeoutFn=ms.bind(q),o.clearTimeoutFn=bs.bind(q)):(o.setTimeoutFn=q.setTimeout.bind(q),o.clearTimeoutFn=q.clearTimeout.bind(q))}const Ss=1.33;function ws(o){return typeof o=="string"?vs(o):Math.ceil((o.byteLength||o.size)*Ss)}function vs(o){let t=0,e=0;for(let s=0,i=o.length;s<i;s++)t=o.charCodeAt(s),t<128?e+=1:t<2048?e+=2:t<55296||t>=57344?e+=3:(s++,e+=4);return e}function Me(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function ks(o){let t="";for(let e in o)o.hasOwnProperty(e)&&(t.length&&(t+="&"),t+=encodeURIComponent(e)+"="+encodeURIComponent(o[e]));return t}function Ms(o){let t={},e=o.split("&");for(let s=0,i=e.length;s<i;s++){let n=e[s].split("=");t[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return t}class Ts extends Error{constructor(t,e,s){super(t),this.description=e,this.context=s,this.type="TransportError"}}class Gt extends P{constructor(t){super(),this.writable=!1,Tt(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,s){return super.emitReserved("error",new Ts(t,e,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(t){this.readyState==="open"&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=qt(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(t){const e=ks(t);return e.length?"?"+e:""}}class Cs extends Gt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||e()})),this.writable||(s++,this.once("drain",function(){--s||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){const e=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};fs(t,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const t=()=>{this.write([{type:"close"}])};this.readyState==="open"?t():this.once("open",t)}write(t){this.writable=!1,cs(t,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Me()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(t,e)}}let Te=!1;try{Te=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const As=Te;function Fs(){}class Es extends Cs{constructor(t){if(super(t),typeof location<"u"){const e=location.protocol==="https:";let s=location.port;s||(s=e?"443":"80"),this.xd=typeof location<"u"&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",(i,n)=>{this.onError("xhr post error",i,n)})}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(e,s)=>{this.onError("xhr poll error",e,s)}),this.pollXhr=t}}class K extends P{constructor(t,e,s){super(),this.createRequest=t,Tt(this,s),this._opts=s,this._method=s.method||"GET",this._uri=e,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var t;const e=ke(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(e);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let i in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(i)&&s.setRequestHeader(i,this._opts.extraHeaders[i])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(t=this._opts.cookieJar)===null||t===void 0||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var i;s.readyState===3&&((i=this._opts.cookieJar)===null||i===void 0||i.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(i){this.setTimeoutFn(()=>{this._onError(i)},0);return}typeof document<"u"&&(this._index=K.requestsCount++,K.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=Fs,t)try{this._xhr.abort()}catch{}typeof document<"u"&&delete K.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;t!==null&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}K.requestsCount=0;K.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",ee);else if(typeof addEventListener=="function"){const o="onpagehide"in q?"pagehide":"unload";addEventListener(o,ee,!1)}}function ee(){for(let o in K.requests)K.requests.hasOwnProperty(o)&&K.requests[o].abort()}const _s=(function(){const o=Ce({xdomain:!1});return o&&o.responseType!==null})();class Rs extends Es{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=_s&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new K(Ce,this.uri(),t)}}function Ce(o){const t=o.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!t||As))return new XMLHttpRequest}catch{}if(!t)try{return new q[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Ae=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Is extends Gt{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,s=Ae?{}:ke(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,s)}catch(i){return this.emitReserved("error",i)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],i=e===t.length-1;Xt(s,this.supportsBinary,n=>{try{this.doWrite(s,n)}catch{}i&&Mt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=Me()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}const _t=q.WebSocket||q.MozWebSocket;class Bs extends Is{createSocket(t,e,s){return Ae?new _t(t,e,s):e?new _t(t,e):new _t(t)}doWrite(t,e){this.ws.send(e)}}class Os extends Gt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then(()=>{this.onClose()}).catch(t=>{this.onError("webtransport error",t)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(t=>{const e=ps(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=t.readable.pipeThrough(e).getReader(),i=us();i.readable.pipeTo(t.writable),this._writer=i.writable.getWriter();const n=()=>{s.read().then(({done:h,value:l})=>{h||(this.onPacket(l),n())}).catch(h=>{})};n();const r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this._writer.write(r).then(()=>this.onOpen())})})}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],i=e===t.length-1;this._writer.write(s).then(()=>{i&&Mt(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var t;(t=this._transport)===null||t===void 0||t.close()}}const Ls={websocket:Bs,webtransport:Os,polling:Rs},Ps=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Ds=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Pt(o){if(o.length>8e3)throw"URI too long";const t=o,e=o.indexOf("["),s=o.indexOf("]");e!=-1&&s!=-1&&(o=o.substring(0,e)+o.substring(e,s).replace(/:/g,";")+o.substring(s,o.length));let i=Ps.exec(o||""),n={},r=14;for(;r--;)n[Ds[r]]=i[r]||"";return e!=-1&&s!=-1&&(n.source=t,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=Us(n,n.path),n.queryKey=$s(n,n.query),n}function Us(o,t){const e=/\/{2,9}/g,s=t.replace(e,"/").split("/");return(t.slice(0,1)=="/"||t.length===0)&&s.splice(0,1),t.slice(-1)=="/"&&s.splice(s.length-1,1),s}function $s(o,t){const e={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,i,n){i&&(e[i]=n)}),e}const Dt=typeof addEventListener=="function"&&typeof removeEventListener=="function",bt=[];Dt&&addEventListener("offline",()=>{bt.forEach(o=>o())},!1);class Z extends P{constructor(t,e){if(super(),this.binaryType=ys,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&typeof t=="object"&&(e=t,t=null),t){const s=Pt(t);e.hostname=s.host,e.secure=s.protocol==="https"||s.protocol==="wss",e.port=s.port,s.query&&(e.query=s.query)}else e.host&&(e.hostname=Pt(e.host).host);Tt(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach(s=>{const i=s.prototype.name;this.transports.push(i),this._transportsByName[i]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Ms(this.opts.query)),Dt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},bt.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=ve,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const t=this.opts.rememberUpgrade&&Z.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",Z.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(e+=ws(i)),s>0&&e>this._maxPayload)return this.writeBuffer.slice(0,s);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(this._pingTimeoutTime=0,Mt(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),t}write(t,e,s){return this._sendPacket("message",t,e,s),this}send(t,e,s){return this._sendPacket("message",t,e,s),this}_sendPacket(t,e,s,i){if(typeof e=="function"&&(i=e,e=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const n={type:t,data:e,options:s};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const t=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():t()}):this.upgrading?s():t()),this}_onError(t){if(Z.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),Dt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=bt.indexOf(this._offlineEventListener);s!==-1&&bt.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}Z.protocol=ve;class Ns extends Z{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),s=!1;Z.priorWebsocketSuccess=!1;const i=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",f=>{if(!s)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Z.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(c(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const p=new Error("probe error");p.transport=e.name,this.emitReserved("upgradeError",p)}}))};function n(){s||(s=!0,c(),e.close(),e=null)}const r=f=>{const p=new Error("probe error: "+f);p.transport=e.name,n(),this.emitReserved("upgradeError",p)};function h(){r("transport closed")}function l(){r("socket closed")}function d(f){e&&f.name!==e.name&&n()}const c=()=>{e.removeListener("open",i),e.removeListener("error",r),e.removeListener("close",h),this.off("close",l),this.off("upgrading",d)};e.once("open",i),e.once("error",r),e.once("close",h),this.once("close",l),this.once("upgrading",d),this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{s||e.open()},200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let s=0;s<t.length;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}let Ws=class extends Ns{constructor(t,e={}){const s=typeof t=="object"?t:e;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(i=>Ls[i]).filter(i=>!!i)),super(t,s)}};function Ys(o,t="",e){let s=o;e=e||typeof location<"u"&&location,o==null&&(o=e.protocol+"//"+e.host),typeof o=="string"&&(o.charAt(0)==="/"&&(o.charAt(1)==="/"?o=e.protocol+o:o=e.host+o),/^(https?|wss?):\/\//.test(o)||(typeof e<"u"?o=e.protocol+"//"+o:o="https://"+o),s=Pt(o)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const n=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+n+":"+s.port+t,s.href=s.protocol+"://"+n+(e&&e.port===s.port?"":":"+s.port),s}const zs=typeof ArrayBuffer=="function",Hs=o=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(o):o.buffer instanceof ArrayBuffer,Fe=Object.prototype.toString,Xs=typeof Blob=="function"||typeof Blob<"u"&&Fe.call(Blob)==="[object BlobConstructor]",qs=typeof File=="function"||typeof File<"u"&&Fe.call(File)==="[object FileConstructor]";function Vt(o){return zs&&(o instanceof ArrayBuffer||Hs(o))||Xs&&o instanceof Blob||qs&&o instanceof File}function St(o,t){if(!o||typeof o!="object")return!1;if(Array.isArray(o)){for(let e=0,s=o.length;e<s;e++)if(St(o[e]))return!0;return!1}if(Vt(o))return!0;if(o.toJSON&&typeof o.toJSON=="function"&&arguments.length===1)return St(o.toJSON(),!0);for(const e in o)if(Object.prototype.hasOwnProperty.call(o,e)&&St(o[e]))return!0;return!1}function Gs(o){const t=[],e=o.data,s=o;return s.data=Ut(e,t),s.attachments=t.length,{packet:s,buffers:t}}function Ut(o,t){if(!o)return o;if(Vt(o)){const e={_placeholder:!0,num:t.length};return t.push(o),e}else if(Array.isArray(o)){const e=new Array(o.length);for(let s=0;s<o.length;s++)e[s]=Ut(o[s],t);return e}else if(typeof o=="object"&&!(o instanceof Date)){const e={};for(const s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=Ut(o[s],t));return e}return o}function Vs(o,t){return o.data=$t(o.data,t),delete o.attachments,o}function $t(o,t){if(!o)return o;if(o&&o._placeholder===!0){if(typeof o.num=="number"&&o.num>=0&&o.num<t.length)return t[o.num];throw new Error("illegal attachments")}else if(Array.isArray(o))for(let e=0;e<o.length;e++)o[e]=$t(o[e],t);else if(typeof o=="object")for(const e in o)Object.prototype.hasOwnProperty.call(o,e)&&(o[e]=$t(o[e],t));return o}const Ks=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var A;(function(o){o[o.CONNECT=0]="CONNECT",o[o.DISCONNECT=1]="DISCONNECT",o[o.EVENT=2]="EVENT",o[o.ACK=3]="ACK",o[o.CONNECT_ERROR=4]="CONNECT_ERROR",o[o.BINARY_EVENT=5]="BINARY_EVENT",o[o.BINARY_ACK=6]="BINARY_ACK"})(A||(A={}));class Js{constructor(t){this.replacer=t}encode(t){return(t.type===A.EVENT||t.type===A.ACK)&&St(t)?this.encodeAsBinary({type:t.type===A.EVENT?A.BINARY_EVENT:A.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id}):[this.encodeAsString(t)]}encodeAsString(t){let e=""+t.type;return(t.type===A.BINARY_EVENT||t.type===A.BINARY_ACK)&&(e+=t.attachments+"-"),t.nsp&&t.nsp!=="/"&&(e+=t.nsp+","),t.id!=null&&(e+=t.id),t.data!=null&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=Gs(t),s=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(s),i}}class Kt extends P{constructor(t){super(),this.reviver=t}add(t){let e;if(typeof t=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const s=e.type===A.BINARY_EVENT;s||e.type===A.BINARY_ACK?(e.type=s?A.EVENT:A.ACK,this.reconstructor=new Qs(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(Vt(t)||t.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+t)}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(A[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===A.BINARY_EVENT||s.type===A.BINARY_ACK){const n=e+1;for(;t.charAt(++e)!=="-"&&e!=t.length;);const r=t.substring(n,e);if(r!=Number(r)||t.charAt(e)!=="-")throw new Error("Illegal attachments");s.attachments=Number(r)}if(t.charAt(e+1)==="/"){const n=e+1;for(;++e&&!(t.charAt(e)===","||e===t.length););s.nsp=t.substring(n,e)}else s.nsp="/";const i=t.charAt(e+1);if(i!==""&&Number(i)==i){const n=e+1;for(;++e;){const r=t.charAt(e);if(r==null||Number(r)!=r){--e;break}if(e===t.length)break}s.id=Number(t.substring(n,e+1))}if(t.charAt(++e)){const n=this.tryParse(t.substr(e));if(Kt.isPayloadValid(s.type,n))s.data=n;else throw new Error("invalid payload")}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch{return!1}}static isPayloadValid(t,e){switch(t){case A.CONNECT:return se(e);case A.DISCONNECT:return e===void 0;case A.CONNECT_ERROR:return typeof e=="string"||se(e);case A.EVENT:case A.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&Ks.indexOf(e[0])===-1);case A.ACK:case A.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Qs{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const e=Vs(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function se(o){return Object.prototype.toString.call(o)==="[object Object]"}const js=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Kt,Encoder:Js,get PacketType(){return A}},Symbol.toStringTag,{value:"Module"}));function V(o,t,e){return o.on(t,e),function(){o.off(t,e)}}const Zs=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Ee extends P{constructor(t,e,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[V(t,"open",this.onopen.bind(this)),V(t,"packet",this.onpacket.bind(this)),V(t,"error",this.onerror.bind(this)),V(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var s,i,n;if(Zs.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const r={type:A.EVENT,data:e};if(r.options={},r.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const c=this.ids++,f=e.pop();this._registerAckCallback(c,f),r.id=c}const h=(i=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||i===void 0?void 0:i.writable,l=this.connected&&!(!((n=this.io.engine)===null||n===void 0)&&n._hasPingExpired());return this.flags.volatile&&!h||(l?(this.notifyOutgoingListeners(r),this.packet(r)):this.sendBuffer.push(r)),this.flags={},this}_registerAckCallback(t,e){var s;const i=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(i===void 0){this.acks[t]=e;return}const n=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let h=0;h<this.sendBuffer.length;h++)this.sendBuffer[h].id===t&&this.sendBuffer.splice(h,1);e.call(this,new Error("operation has timed out"))},i),r=(...h)=>{this.io.clearTimeoutFn(n),e.apply(this,h)};r.withError=!0,this.acks[t]=r}emitWithAck(t,...e){return new Promise((s,i)=>{const n=(r,h)=>r?i(r):s(h);n.withError=!0,e.push(n),this.emit(t,...e)})}_addToQueue(t){let e;typeof t[t.length-1]=="function"&&(e=t.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((i,...n)=>(this._queue[0],i!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(i)):(this._queue.shift(),e&&e(null,...n)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){typeof this.auth=="function"?this.auth(t=>{this._sendConnectPacket(t)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:A.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(t=>{if(!this.sendBuffer.some(s=>String(s.id)===t)){const s=this.acks[t];delete this.acks[t],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case A.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case A.EVENT:case A.BINARY_EVENT:this.onevent(t);break;case A.ACK:case A.BINARY_ACK:this.onack(t);break;case A.DISCONNECT:this.ondisconnect();break;case A.CONNECT_ERROR:this.destroy();const s=new Error(t.data.message);s.data=t.data.data,this.emitReserved("connect_error",s);break}}onevent(t){const e=t.data||[];t.id!=null&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&typeof t[t.length-1]=="string"&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let s=!1;return function(...i){s||(s=!0,e.packet({type:A.ACK,id:t,data:i}))}}onack(t){const e=this.acks[t.id];typeof e=="function"&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:A.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const s of e)s.apply(this,t.data)}}}function rt(o){o=o||{},this.ms=o.min||100,this.max=o.max||1e4,this.factor=o.factor||2,this.jitter=o.jitter>0&&o.jitter<=1?o.jitter:0,this.attempts=0}rt.prototype.duration=function(){var o=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),e=Math.floor(t*this.jitter*o);o=(Math.floor(t*10)&1)==0?o-e:o+e}return Math.min(o,this.max)|0};rt.prototype.reset=function(){this.attempts=0};rt.prototype.setMin=function(o){this.ms=o};rt.prototype.setMax=function(o){this.max=o};rt.prototype.setJitter=function(o){this.jitter=o};class Nt extends P{constructor(t,e){var s;super(),this.nsps={},this.subs=[],t&&typeof t=="object"&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,Tt(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((s=e.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new rt({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=t;const i=e.parser||js;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return t===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return t===void 0?this._reconnectionDelay:(this._reconnectionDelay=t,(e=this.backoff)===null||e===void 0||e.setMin(t),this)}randomizationFactor(t){var e;return t===void 0?this._randomizationFactor:(this._randomizationFactor=t,(e=this.backoff)===null||e===void 0||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return t===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,(e=this.backoff)===null||e===void 0||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new Ws(this.uri,this.opts);const e=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=V(e,"open",function(){s.onopen(),t&&t()}),n=h=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",h),t?t(h):this.maybeReconnectOnOpen()},r=V(e,"error",n);if(this._timeout!==!1){const h=this._timeout,l=this.setTimeoutFn(()=>{i(),n(new Error("timeout")),e.close()},h);this.opts.autoUnref&&l.unref(),this.subs.push(()=>{this.clearTimeoutFn(l)})}return this.subs.push(i),this.subs.push(r),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(V(t,"ping",this.onping.bind(this)),V(t,"data",this.ondata.bind(this)),V(t,"error",this.onerror.bind(this)),V(t,"close",this.onclose.bind(this)),V(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error",e)}}ondecoded(t){Mt(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s?this._autoConnect&&!s.active&&s.connect():(s=new Ee(this,t,e),this.nsps[t]=s),s}_destroy(t){const e=Object.keys(this.nsps);for(const s of e)if(this.nsps[s].active)return;this._close()}_packet(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),!t.skipReconnect&&t.open(i=>{i?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",i)):t.onreconnect()}))},e);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const lt={};function wt(o,t){typeof o=="object"&&(t=o,o=void 0),t=t||{};const e=Ys(o,t.path||"/socket.io"),s=e.source,i=e.id,n=e.path,r=lt[i]&&n in lt[i].nsps,h=t.forceNew||t["force new connection"]||t.multiplex===!1||r;let l;return h?l=new Nt(s,t):(lt[i]||(lt[i]=new Nt(s,t)),l=lt[i]),e.query&&!t.query&&(t.query=e.queryKey),l.socket(e.path,t)}Object.assign(wt,{Manager:Nt,Socket:Ee,io:wt,connect:wt});const pt={JOIN:"client:join",INPUT:"client:input",PING:"client:ping",LEAVE:"client:leave"},st={JOINED:"server:joined",STATE:"server:state",KILL:"server:kill",PORTAL_EXIT:"server:portal_exit",GAME_OVER:"server:game_over",PONG:"server:pong",ERROR:"server:error"},xs=1,ti=3,ei=4,si=5,ii=0,ni=1,oi=2,ri=3,ai=4,li=0,hi=1,di=2,ci=3,fi=4,ui=5,pi=6;function gi(o){switch(o){case ii:return it.Lobby;case ni:return it.Countdown;case oi:return it.Playing;case ri:return it.Shrinking;case ai:return it.GameOver;default:return it.Lobby}}function yi(o){switch(o){case li:return G.RapidFire;case hi:return G.Speed;case di:return G.Shield;case ci:return G.Magnet;case fi:return G.Heal;case ui:return G.OpticalSight;case pi:return G.Rocket;default:return G.RapidFire}}class mi{constructor(t,e=new Map){m(this,"view");m(this,"offset",0);m(this,"starPositions");m(this,"tankMeta");this.starPositions=t,this.tankMeta=e,this.view=new DataView(new ArrayBuffer(0))}decode(t){if(this.view=new DataView(t),this.offset=0,t.byteLength<1)return{type:"unknown"};switch(this.readUint8()){case xs:return{type:"fullState",state:this.decodeFullState()};case ti:return this.decodeLeaderboard();case ei:return this.decodeKillEvent();case si:return this.decodePortalExitEvent();default:return{type:"unknown"}}}decodeFullState(){const t=this.readUint32(),e=this.readFloat32(),s=this.readUint8(),i=this.readUint8(),n=this.readFloat32(),r=this.readUint16(),h=gi(s),l=this.decodeZone(),d=this.readUint8(),c=[];for(let w=0;w<d;w++)c.push(this.decodeStar());const f=this.readUint8(),p=[];for(let w=0;w<f;w++)p.push(this.decodeBullet());const u=this.readUint8(),g=[];for(let w=0;w<u;w++)g.push(this.decodePowerUp());const a=this.readUint8(),y=[];for(let w=0;w<a;w++)y.push(this.decodePortal());const b=this.readUint8(),v=[];for(let w=0;w<b;w++)v.push(this.decodeTank());const S=this.readUint8(),k=[];for(let w=0;w<S;w++)k.push(this.decodeLeaderboardEntry());let T=null;if(this.readUint8()){const w=this.readFloat32(),_=this.readFloat32(),B=this.readUint16(),C=this.readUint16(),R=this.readUint8(),I=this.readFloat32(),D=this.readUint8()===1,et=this.readUint8()?this.readFloat32():(this.offset+=4,void 0),nt=this.readUint8(),at=["circularBarrage","fanShot","spiral","rotatingLaser","tripleShot","teleportExplosion","mineField","bulletWave","chaosFire","rageMode"],Ct=nt>0?at[nt-1]:null;T={id:"boss_1",position:{x:w,y:_},hp:B,maxHp:C,currentAttack:Ct,lastAttackTime:0,nextAttackAt:0,phase:R,angle:I,laserAngle:et,isAlive:D,lastPhaseRewardAt:0}}let E=null;if(this.offset<this.view.byteLength&&this.readUint8()){const _=this.readFloat32(),B=this.readFloat32(),C=this.readFloat32(),R=this.readFloat32(),I=this.readUint8(),D=this.readUint8(),N=this.readUint16(),et=this.readUint16(),nt=this.readUint16(),at=this.readUint16(),Ct=this.readUint16(),Ie=this.readUint16(),Be=this.readUint16(),Oe=this.readUint16(),Jt=this.readUint8();E={flagA:{x:_,y:B},flagB:{x:C,y:R},flagACarrier:null,flagBCarrier:null,flagADropped:(Jt&1)!==0,flagBDropped:(Jt&2)!==0,scoreA:I,scoreB:D,baseA:{x:N,y:et,w:nt,h:at},baseB:{x:Ct,y:Ie,w:Be,h:Oe}}}const M=[];if(this.offset+2<=this.view.byteLength){const w=this.readUint16();for(let _=0;_<w;_++){const B=this.readUint8(),C=this.readUint8();M.push({x:B,y:C})}}return{tick:t,timestamp:e,phase:h,tanks:v,bullets:p,stars:c,powerUps:g,portals:y,zone:l,boss:T,ctf:E,ctfTimeRemaining:r,destroyedObstacles:M,leaderboard:k,playersAlive:i,timeElapsed:n}}decodeTank(){const t=this.readUint8(),e=this.readFloat32(),s=this.readFloat32(),i=this.readFloat32(),n=this.readFloat32(),r=this.readUint8(),h=this.readUint8(),l=this.readUint16(),d=this.readUint16(),c=this.readUint8();this.readUint8();const f=this.readFloat32(),p=this.readUint16(),u=this.readFloat32(),g=(c&1)!==0,a=(c&2)!==0,y=c>>2&3,b=y===1?"a":y===2?"b":void 0,v=(c&16)!==0;let S=null;f>0&&(S=G.RapidFire);const k=this.tankMeta.get(t),T=(k==null?void 0:k.id)??`tank-${t}`,F=(k==null?void 0:k.name)??`Player ${t}`,E=(k==null?void 0:k.color)??"#ffffff";return{id:T,name:F,position:{x:e,y:s},hullAngle:i,turretAngle:n,hp:r,maxHp:h,stars:l,kills:d,isBot:a,isAlive:g,activePowerUp:S,powerUpEndTime:f,lastFireTime:0,fireCooldown:p,speed:0,color:E,magnetRadius:1,tankRadius:u,lastDamageTime:0,quicksandSlowEndTime:0,inBush:!1,team:b,hasFlag:v||void 0}}decodeBullet(){const t=this.readUint8(),e=this.readFloat32(),s=this.readFloat32(),i=this.readFloat32(),n=this.readUint8(),r=n&127,h=(n&128)!==0;return{id:`bullet-${t}`,ownerId:"",position:{x:e,y:s},angle:i,distanceTraveled:r,isRocket:h}}decodeStar(){const t=this.readUint8(),e=this.readUint8()!==0,s=this.readFloat32(),i=this.starPositions[t]??{x:0,y:0};return{id:`star-${t}`,position:i,active:e,respawnAt:s}}decodePowerUp(){const t=this.readFloat32(),e=this.readFloat32(),s=this.readUint8(),i=this.readUint8(),n=yi(s);return{id:`powerup-${Math.random()}`,type:n,position:{x:t,y:e},spawnedAt:i}}decodePortal(){const t=this.readFloat32(),e=this.readFloat32();return this.readUint8(),{id:`portal-${Math.random()}`,position:{x:t,y:e},spawnedAt:0,expiresAt:0}}decodeZone(){const t=this.readFloat32(),e=this.readFloat32(),s=this.readFloat32(),i=this.readFloat32(),n=this.readUint8(),r=this.readUint8()!==0;return{centerX:t,centerY:e,currentRadius:s,targetRadius:i,shrinkSpeed:0,phase:n,isShrinking:r,nextShrinkAt:0}}decodeLeaderboard(){const t=this.readUint32(),e=this.readUint8(),s=[];for(let i=0;i<e;i++)s.push(this.decodeLeaderboardEntry());return{type:"leaderboard",leaderboard:s,tick:t}}decodeLeaderboardEntry(){const t=this.readUint8(),e=this.readUint16(),s=this.readUint16(),n=(this.readUint8()&1)!==0,r=this.tankMeta.get(t),h=(r==null?void 0:r.id)??`tank-${t}`,l=(r==null?void 0:r.name)??`Player ${t}`;return{id:h,name:l,kills:e,stars:s,isAlive:n}}decodeKillEvent(){const t=this.readUint8(),e=this.readUint8(),s=this.readFloat32(),i=this.tankMeta.get(t),n=this.tankMeta.get(e);return{type:"killEvent",data:{killerId:(i==null?void 0:i.id)??`tank-${t}`,killerName:(i==null?void 0:i.name)??`Player ${t}`,victimId:(n==null?void 0:n.id)??`tank-${e}`,victimName:(n==null?void 0:n.name)??`Player ${e}`,timestamp:s}}}decodePortalExitEvent(){const t=this.readUint8(),e=this.readFloat32(),s=this.readFloat32(),i=this.readFloat32(),n=this.tankMeta.get(t);return{type:"portalExitEvent",data:{tankId:(n==null?void 0:n.id)??`tank-${t}`,tankName:(n==null?void 0:n.name)??`Player ${t}`,exitPosition:{x:e,y:s},timestamp:i}}}updateTankMeta(t,e){this.tankMeta.set(t,e)}removeTankMeta(t){this.tankMeta.delete(t)}readUint8(){const t=this.view.getUint8(this.offset);return this.offset+=1,t}readUint16(){const t=this.view.getUint16(this.offset,!0);return this.offset+=2,t}readUint32(){const t=this.view.getUint32(this.offset,!0);return this.offset+=4,t}readFloat32(){const t=this.view.getFloat32(this.offset,!0);return this.offset+=4,t}}const bi="https://tank-br-server.onrender.com";class Si{constructor(t){m(this,"socket");m(this,"latency",0);m(this,"decoder",null);this.socket=wt(bi,{transports:["websocket"],autoConnect:!1}),this.socket.on(st.JOINED,e=>{const s=e;if(s.starPositions&&s.tankMeta){const i=new Map;for(const n of s.tankMeta)i.set(n.index,{id:n.id,name:n.name,color:n.color});this.decoder=new mi(s.starPositions,i)}t.onJoined(e)}),this.socket.on(st.STATE,e=>{if(e instanceof ArrayBuffer&&this.decoder)try{const s=this.decoder.decode(e);if(s.type==="fullState"){t.onState(s.state);return}}catch{}t.onState(e)}),this.socket.on(st.KILL,e=>{t.onKill(e)}),this.socket.on(st.PORTAL_EXIT,e=>{t.onPortalExit(e)}),this.socket.on(st.GAME_OVER,e=>{t.onGameOver(e)}),this.socket.on(st.ERROR,e=>{t.onError(e.message)}),this.socket.on(st.PONG,e=>{this.latency=Date.now()-e.timestamp}),this.socket.on("disconnect",()=>{t.onDisconnect()})}connect(){this.socket.connect()}join(t,e,s,i,n,r){const h={playerName:t,mapId:e,color:s,ctfTeam:i,ctfBotsA:n,ctfBotsB:r};this.socket.emit(pt.JOIN,h)}sendInput(t){this.socket.emit(pt.INPUT,t)}ping(){this.socket.emit(pt.PING,{timestamp:Date.now()})}leave(){this.socket.emit(pt.LEAVE,{})}disconnect(){this.socket.disconnect()}get currentLatency(){return this.latency}get id(){return this.socket.id??""}get connected(){return this.socket.connected}}const wi=80,ie=25;class vi{constructor(){m(this,"buffer",[]);m(this,"maxSize",30);m(this,"debugInfo",{mode:"waiting",bufferSize:0,packetGapMs:0,extrapolateMs:0})}push(t){const e=new Map;for(const i of t.tanks)e.set(i.id,i);const s=new Map;for(const i of t.bullets)s.set(i.id,i);this.buffer.push({state:t,receiveTime:Date.now(),tankMap:e,bulletMap:s}),this.buffer.length>this.maxSize&&this.buffer.shift()}getInterpolatedState(){if(this.buffer.length===0)return this.debugInfo.mode="waiting",this.debugInfo.bufferSize=0,null;if(this.buffer.length===1)return this.debugInfo.mode="single",this.debugInfo.bufferSize=1,this.buffer[0].state;const t=Date.now()-wi;let e=null,s=null;for(let h=0;h<this.buffer.length-1;h++)if(this.buffer[h].receiveTime<=t&&this.buffer[h+1].receiveTime>=t){e=this.buffer[h],s=this.buffer[h+1];break}if(!e||!s){if(this.buffer.length>=2){const h=this.buffer[this.buffer.length-2],l=this.buffer[this.buffer.length-1],d=l.receiveTime-h.receiveTime;if(this.debugInfo={mode:"extrapolating",bufferSize:this.buffer.length,packetGapMs:d,extrapolateMs:t-l.receiveTime},d>0){const c=t-l.receiveTime,f=Math.min(c/d,1.5);if(f>0){const p=l.state.tanks.map(g=>{const a=h.tankMap.get(g.id);if(!a||!a.isAlive&&g.isAlive)return g;const y=g.position.x-a.position.x,b=g.position.y-a.position.y;return y*y+b*b>ie?g:{...g,position:{x:g.position.x+(g.position.x-a.position.x)*f,y:g.position.y+(g.position.y-a.position.y)*f},hullAngle:ct(a.hullAngle,g.hullAngle,1+f),turretAngle:ct(a.turretAngle,g.turretAngle,1+f)}}),u=l.state.bullets.map(g=>{const a=h.bulletMap.get(g.id);return a?{...g,position:{x:g.position.x+(g.position.x-a.position.x)*f,y:g.position.y+(g.position.y-a.position.y)*f}}:g});return{...l.state,tanks:p,bullets:u}}}}return this.buffer[this.buffer.length-1].state}this.debugInfo={mode:"interpolating",bufferSize:this.buffer.length,packetGapMs:s.receiveTime-e.receiveTime,extrapolateMs:0};const i=(t-e.receiveTime)/(s.receiveTime-e.receiveTime),n=i*i*(3-2*i),r=s.state.tanks.map(h=>{const l=e.tankMap.get(h.id);if(!l||!l.isAlive&&h.isAlive)return h;const d=h.position.x-l.position.x,c=h.position.y-l.position.y;return d*d+c*c>ie?h:{...h,position:{x:Qt(l.position.x,h.position.x,n),y:Qt(l.position.y,h.position.y,n)},hullAngle:ct(l.hullAngle,h.hullAngle,n),turretAngle:ct(l.turretAngle,h.turretAngle,n)}});return{...s.state,tanks:r}}clear(){this.buffer=[]}get size(){return this.buffer.length}}class ki{constructor(t){m(this,"visible",!1);m(this,"stars",0);m(this,"isWin",!1);m(this,"leaderboard",[]);m(this,"onPlayAgain",null);m(this,"canvas");m(this,"showTime",0);this.canvas=t,t.addEventListener("click",e=>this.handleClick(e))}show(t,e,s){this.visible=!0,this.stars=t,this.isWin=t>0,this.leaderboard=e,this.onPlayAgain=s,this.showTime=performance.now()}hide(){this.visible=!1}get isVisible(){return this.visible}render(t){if(!this.visible)return;const e=t.canvas.width,s=t.canvas.height,i=(performance.now()-this.showTime)/1e3,n=Math.min(i/.5,1);if(this.isWin){const C=t.createRadialGradient(e/2,s*.3,0,e/2,s/2,s);C.addColorStop(0,`rgba(60, 50, 10, ${.95*n})`),C.addColorStop(.5,`rgba(20, 20, 10, ${.95*n})`),C.addColorStop(1,`rgba(5, 5, 5, ${.97*n})`),t.fillStyle=C}else t.fillStyle=`rgba(10, 5, 5, ${.95*n})`;if(t.fillRect(0,0,e,s),this.isWin){t.save();for(let C=0;C<30;C++){const R=e*.1+C*137.5%e*.8,I=s-(i*30+C*47)%s,D=2+C%3;t.globalAlpha=.3+.3*Math.sin(i*2+C),t.fillStyle="#FFD700",t.beginPath(),t.arc(R,I,D,0,Math.PI*2),t.fill()}t.restore()}const r=Math.min(e,s)/600,h=s*.16,l=Math.max(28,60*r),d=Math.min(n*1.2,1);t.save(),t.translate(e/2,h),t.scale(d,d),this.isWin?(t.shadowColor="rgba(255, 215, 0, 0.6)",t.shadowBlur=30,t.fillStyle="#FFD700"):(t.shadowColor="rgba(255, 50, 50, 0.5)",t.shadowBlur=20,t.fillStyle="#FF4444"),t.font=`bold ${l}px 'Segoe UI', Arial, sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText(this.isWin?"VICTORY":"DEFEAT",0,0),t.shadowBlur=0,t.restore();const c=s*.26,f=Math.max(18,28*r);t.fillStyle=this.isWin?"#FFD700":"rgba(255,255,255,0.7)",t.font=`bold ${f}px 'Segoe UI', Arial, sans-serif`,t.textAlign="center",t.textBaseline="middle";const p=`★ ${this.stars} stars extracted`;t.fillText(p,e/2,c);const u=Math.min(300,e*.5),g=s*.31,a=t.createLinearGradient(e/2-u/2,0,e/2+u/2,0);a.addColorStop(0,"rgba(255,215,0,0)"),a.addColorStop(.5,"rgba(255,215,0,0.4)"),a.addColorStop(1,"rgba(255,215,0,0)"),t.strokeStyle=a,t.lineWidth=1,t.beginPath(),t.moveTo(e/2-u/2,g),t.lineTo(e/2+u/2,g),t.stroke();const y=s*.35,b=Math.max(12,16*r);t.fillStyle="rgba(255, 215, 0, 0.7)",t.font=`bold ${b}px 'Segoe UI', Arial, sans-serif`,t.textAlign="center",t.letterSpacing="3px",t.fillText("LEADERBOARD",e/2,y);const v=Math.max(11,15*r),S=Math.max(18,24*r),k=this.leaderboard.slice(0,8),T=y+S*1.2,F=Math.min(350,e*.6);for(let C=0;C<k.length;C++){const R=k[C],I=T+C*S;if(C<3){const et=(3-C)*.04;t.fillStyle=`rgba(255, 215, 0, ${et})`,this.roundRect(t,e/2-F/2,I-S*.4,F,S*.85,4),t.fill()}const D=["#FFD700","#C0C0C0","#CD7F32"];t.fillStyle=C<3?D[C]:"rgba(255,255,255,0.5)",t.font=`bold ${v}px 'Segoe UI', Arial, sans-serif`,t.textAlign="left",t.textBaseline="middle",t.fillText(`${C+1}.`,e/2-F/2+8,I);const N=R.name.length>12?R.name.slice(0,12)+"..":R.name;t.fillStyle=R.isAlive?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.4)",t.font=`${v}px 'Segoe UI', Arial, sans-serif`,t.fillText(N,e/2-F/2+36,I),t.textAlign="right",t.fillStyle="#FFD700",t.font=`bold ${v}px 'Segoe UI', Arial, sans-serif`,t.fillText(`★${R.stars}`,e/2+F/2-8,I),t.fillStyle="rgba(255,100,100,0.7)",t.font=`${v*.85}px 'Segoe UI', Arial, sans-serif`,t.fillText(`${R.kills}K`,e/2+F/2-55,I)}const E=Math.min(220,e*.4),M=Math.max(40,50*r),w=(e-E)/2,_=s*.88-M/2;t.shadowColor="rgba(255, 215, 0, 0.4)",t.shadowBlur=15;const B=t.createLinearGradient(w,_,w+E,_+M);B.addColorStop(0,"#FFD700"),B.addColorStop(1,"#FFA500"),t.fillStyle=B,this.roundRect(t,w,_,E,M,12),t.fill(),t.shadowBlur=0,t.fillStyle="#1a1a2e",t.font=`bold ${Math.max(14,18*r)}px 'Segoe UI', Arial, sans-serif`,t.textAlign="center",t.textBaseline="middle",t.fillText("PLAY AGAIN",e/2,_+M/2)}handleClick(t){var g;if(!this.visible)return;const e=this.canvas.getBoundingClientRect(),s=this.canvas.width/e.width,i=this.canvas.height/e.height,n=(t.clientX-e.left)*s,r=(t.clientY-e.top)*i,h=this.canvas.width,l=this.canvas.height,d=Math.min(h,l)/600,c=Math.min(220,h*.4),f=Math.max(40,50*d),p=(h-c)/2,u=l*.88-f/2;n>=p&&n<=p+c&&r>=u&&r<=u+f&&(this.hide(),(g=this.onPlayAgain)==null||g.call(this))}roundRect(t,e,s,i,n,r){t.beginPath(),t.moveTo(e+r,s),t.lineTo(e+i-r,s),t.quadraticCurveTo(e+i,s,e+i,s+r),t.lineTo(e+i,s+n-r),t.quadraticCurveTo(e+i,s+n,e+i-r,s+n),t.lineTo(e+r,s+n),t.quadraticCurveTo(e,s+n,e,s+n-r),t.lineTo(e,s+r),t.quadraticCurveTo(e,s,e+r,s),t.closePath()}}const ne=50,oe=15;class Mi{constructor(t,e){m(this,"active",!1);m(this,"moveStick",{touchId:null,startX:0,startY:0,currentX:0,currentY:0});m(this,"aimStick",{touchId:null,startX:0,startY:0,currentX:0,currentY:0});this.canvas=t,this.inputManager=e,"ontouchstart"in window&&(this.active=!0,this.inputManager.setIsMobile(!0),t.addEventListener("touchstart",s=>this.handleTouchStart(s),{passive:!1}),t.addEventListener("touchmove",s=>this.handleTouchMove(s),{passive:!1}),t.addEventListener("touchend",s=>this.handleTouchEnd(s),{passive:!1}),t.addEventListener("touchcancel",s=>this.handleTouchEnd(s),{passive:!1}))}handleTouchStart(t){t.preventDefault();const e=this.canvas.getBoundingClientRect(),s=e.width/2;for(let i=0;i<t.changedTouches.length;i++){const n=t.changedTouches[i];n.clientX-e.left<=s?this.moveStick.touchId===null&&(this.moveStick.touchId=n.identifier,this.moveStick.startX=n.clientX,this.moveStick.startY=n.clientY,this.moveStick.currentX=n.clientX,this.moveStick.currentY=n.clientY):this.aimStick.touchId===null&&(this.aimStick.touchId=n.identifier,this.aimStick.startX=n.clientX,this.aimStick.startY=n.clientY,this.aimStick.currentX=n.clientX,this.aimStick.currentY=n.clientY)}}handleTouchMove(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];s.identifier===this.moveStick.touchId&&(this.moveStick.currentX=s.clientX,this.moveStick.currentY=s.clientY,this.updateMoveInput()),s.identifier===this.aimStick.touchId&&(this.aimStick.currentX=s.clientX,this.aimStick.currentY=s.clientY,this.updateAimInput())}}handleTouchEnd(t){t.preventDefault();for(let e=0;e<t.changedTouches.length;e++){const s=t.changedTouches[e];s.identifier===this.moveStick.touchId&&(this.moveStick.touchId=null,this.inputManager.setMobileMove(null)),s.identifier===this.aimStick.touchId&&(this.aimStick.touchId=null,this.inputManager.setMobileAim(null,!1))}}updateMoveInput(){const t=this.moveStick.currentX-this.moveStick.startX,e=this.moveStick.currentY-this.moveStick.startY;if(Math.sqrt(t*t+e*e)<oe){this.inputManager.setMobileMove(null);return}const i=Math.atan2(t,-e);this.inputManager.setMobileMove(i)}updateAimInput(){const t=this.aimStick.currentX-this.aimStick.startX,e=this.aimStick.currentY-this.aimStick.startY;if(Math.sqrt(t*t+e*e)<oe){this.inputManager.setMobileAim(null,!1);return}const i=Math.atan2(t,-e);this.inputManager.setMobileAim(i,!0)}render(t){this.active&&(this.moveStick.touchId!==null&&this.renderJoystick(t,this.moveStick,"rgba(100, 200, 255, 0.3)","rgba(100, 200, 255, 0.5)"),this.aimStick.touchId!==null&&this.renderJoystick(t,this.aimStick,"rgba(255, 100, 100, 0.3)","rgba(255, 100, 100, 0.5)"))}renderJoystick(t,e,s,i){const n=this.canvas.getBoundingClientRect(),r=e.startX-n.left,h=e.startY-n.top;t.strokeStyle=s,t.lineWidth=2,t.beginPath(),t.arc(r,h,ne,0,Math.PI*2),t.stroke();const l=e.currentX-e.startX,d=e.currentY-e.startY,c=Math.min(Math.sqrt(l*l+d*d),ne),f=Math.atan2(d,l),p=r+Math.cos(f)*c,u=h+Math.sin(f)*c;t.fillStyle=i,t.beginPath(),t.arc(p,u,20,0,Math.PI*2),t.fill()}get isActive(){return this.active}}const Ti=[{id:"lakes",name:"Озёра",description:"Природный ландшафт с озёрами",botCount:10},{id:"megapolis",name:"Мегаполис",description:"Городские кварталы и улицы",botCount:5},{id:"village",name:"Село",description:"Деревня с полями и речкой",botCount:0},{id:"ctf",name:"Захват Флага",description:"2 команды, захвати вражеский флаг",botCount:6}],Ci=[["#3a3a3a","#5a4a3a","#2a4a2a","#4a3a2a","#2a3a5a","#5a2a2a","#4a4a2a","#2a5a5a","#6a5a4a","#3a5a3a","#5a3a5a","#4a6a4a"],["#4488FF","#FF4444","#44CC44","#FFAA00","#CC44CC","#44CCCC","#FF6644","#88FF44","#4466FF","#FF44AA","#AAFF44","#44AAFF"],["#3366CC","#CC3333","#33AA33","#CC8800","#AA33AA","#33AAAA","#CC5533","#66CC33","#3355CC","#CC3388","#88CC33","#3388CC"],["#333333","#4a4a4a","#2a2a2a","#555555","#3a2a2a","#2a3a3a","#2a2a3a","#3a3a2a","#606060","#1a1a1a","#4a3a3a","#3a3a4a"]],Ai=["Treads","Body","Turret","Barrel"],Fi=["treads","body","turret","barrel"];function Ei(){const o=localStorage.getItem("tankbr_colors");if(o)try{const e=JSON.parse(o);if(e.treads&&e.body&&e.turret&&e.barrel)return e}catch{}return{treads:"#3a3a3a",body:localStorage.getItem("tankbr_color")??pe[0],turret:"#3366CC",barrel:"#333333"}}class _i{constructor(t){m(this,"visible",!0);m(this,"playerName",localStorage.getItem("tankbr_name")??"");m(this,"selectedMap",localStorage.getItem("tankbr_map")||"lakes");m(this,"selectedColor",localStorage.getItem("tankbr_color")??pe[0]);m(this,"tankColors",Ei());m(this,"onJoin",null);m(this,"nameInput",null);m(this,"container",null);m(this,"accountStars",null);m(this,"errorMessage",null);m(this,"previewCanvas",null);m(this,"ctfTeam","a");m(this,"ctfBotsA",3);m(this,"ctfBotsB",3);m(this,"ctfPanel",null);this.canvas=t}get customTankColors(){return this.tankColors}show(t,e,s){this.visible=!0,this.onJoin=t,this.accountStars=e??null,this.errorMessage=s??null,this.createUI()}updateAccountStars(t){this.accountStars=t,this.visible&&(this.hide(),this.show(this.onJoin,t))}hide(){var t;this.visible=!1,(t=this.container)==null||t.remove(),this.container=null,this.previewCanvas=null}get isVisible(){return this.visible}createUI(){if(this.container)return;this.container=document.createElement("div"),this.container.style.cssText=`
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1a3e 40%, #0d1b2a 100%);
      color: white; font-family: 'Segoe UI', Arial, sans-serif; z-index: 10;
      overflow-y: auto; padding: 30px 0;
    `;const t=document.createElement("style");t.textContent=`
      @keyframes float { 0%,100% { transform: translateY(0) rotate(0deg); opacity: 0.3; } 50% { transform: translateY(-20px) rotate(180deg); opacity: 0.6; } }
      .lobby-particle { position: fixed; width: 4px; height: 4px; background: #FFD700; border-radius: 50%; pointer-events: none; animation: float linear infinite; }
    `,this.container.appendChild(t);for(let M=0;M<20;M++){const w=document.createElement("div");w.className="lobby-particle",w.style.left=`${Math.random()*100}%`,w.style.top=`${Math.random()*100}%`,w.style.animationDuration=`${3+Math.random()*4}s`,w.style.animationDelay=`${Math.random()*3}s`,w.style.width=w.style.height=`${2+Math.random()*4}px`,this.container.appendChild(w)}const e=document.createElement("div");e.style.cssText=`
      position: relative; z-index: 1; display: flex; flex-direction: column;
      align-items: center; max-width: 800px; width: 95%;
    `;const s=document.createElement("h1");s.textContent="TANK BATTLE ROYALE",s.style.cssText=`
      color: #FFD700; font-size: clamp(2em, 5vw, 3.2em); margin: 0 0 8px 0;
      text-shadow: 0 0 20px rgba(255,215,0,0.5), 0 0 40px rgba(255,215,0,0.2);
      letter-spacing: 4px; font-weight: 900;
    `,e.appendChild(s);const i=document.createElement("div");i.textContent="COLLECT STARS. SURVIVE. EXTRACT.",i.style.cssText=`
      font-size: 14px; color: rgba(255,215,0,0.6); letter-spacing: 5px;
      margin-bottom: 18px; font-weight: 600;
    `,e.appendChild(i);const n=document.createElement("div"),r=this.accountStars!==null?this.accountStars:50;n.style.cssText=`
      background: linear-gradient(135deg, rgba(255,215,0,0.15) 0%, rgba(255,180,0,0.05) 100%);
      border: 1px solid rgba(255,215,0,0.3); border-radius: 14px;
      padding: 14px 36px; margin-bottom: 8px; text-align: center;
    `,n.innerHTML=`
      <div style="font-size: 32px; color: #FFD700; font-weight: bold; text-shadow: 0 0 10px rgba(255,215,0,0.3);">★ ${r}</div>
      <div style="font-size: 13px; color: rgba(255,215,0,0.5); margin-top: 3px; letter-spacing: 2px;">YOUR STARS</div>
    `,e.appendChild(n);const h=document.createElement("div");if(h.textContent="Entry: 2 ★",h.style.cssText="font-size: 14px; color: rgba(170,170,170,0.7); margin-bottom: 16px;",e.appendChild(h),this.errorMessage){const M=document.createElement("div");M.textContent=this.errorMessage,M.style.cssText=`
        background: linear-gradient(135deg, rgba(255,60,60,0.9), rgba(200,30,30,0.9));
        color: white; padding: 8px 18px; border-radius: 10px;
        margin-bottom: 10px; font-size: 13px; font-weight: 600;
        box-shadow: 0 4px 15px rgba(255,0,0,0.3);
      `,e.appendChild(M)}this.nameInput=document.createElement("input"),this.nameInput.type="text",this.nameInput.placeholder="Enter your name",this.nameInput.maxLength=15,this.nameInput.value=this.playerName||"",this.nameInput.style.cssText=`
      padding: 14px 22px; font-size: 18px; border: 2px solid rgba(255,215,0,0.4);
      background: rgba(255,255,255,0.07); color: white; border-radius: 12px;
      width: 320px; text-align: center; margin-bottom: 20px; outline: none;
      font-family: 'Segoe UI', Arial, sans-serif; transition: border-color 0.3s, box-shadow 0.3s;
    `,this.nameInput.addEventListener("focus",()=>{this.nameInput.style.borderColor="rgba(255,215,0,0.8)",this.nameInput.style.boxShadow="0 0 15px rgba(255,215,0,0.2)"}),this.nameInput.addEventListener("blur",()=>{this.nameInput.style.borderColor="rgba(255,215,0,0.4)",this.nameInput.style.boxShadow="none"}),e.appendChild(this.nameInput);const l=document.createElement("div");l.style.cssText=`
      width: 100%; margin-bottom: 20px;
      display: flex; gap: 24px; align-items: flex-start; justify-content: center;
      flex-wrap: wrap;
    `;const d=document.createElement("div");d.style.cssText="display: flex; flex-direction: column; gap: 10px;";const c=document.createElement("div");c.textContent="CUSTOMIZE TANK",c.style.cssText=`
      font-size: 14px; letter-spacing: 3px; color: rgba(170,170,170,0.7);
      margin-bottom: 6px; text-align: center;
    `,d.appendChild(c);for(let M=0;M<4;M++){const w=document.createElement("div");w.style.cssText="display: flex; align-items: center; gap: 10px;";const _=document.createElement("div");_.textContent=Ai[M],_.style.cssText=`
        font-size: 14px; color: rgba(200,200,200,0.8); width: 60px;
        text-align: right; flex-shrink: 0;
      `,w.appendChild(_);const B=Ci[M],C=document.createElement("div");C.style.cssText="display: flex; gap: 5px; flex-wrap: wrap;";for(const R of B){const I=document.createElement("div"),D=Fi[M],N=this.tankColors[D]===R;I.style.cssText=`
          width: 28px; height: 28px; border-radius: 5px; cursor: pointer;
          background: ${R};
          border: 2px solid ${N?"#FFD700":"rgba(255,255,255,0.1)"};
          transition: all 0.15s;
        `,I.addEventListener("mouseenter",()=>{this.tankColors[D]!==R&&(I.style.borderColor="rgba(255,255,255,0.4)")}),I.addEventListener("mouseleave",()=>{this.tankColors[D]!==R&&(I.style.borderColor="rgba(255,255,255,0.1)")}),I.addEventListener("click",()=>{this.tankColors={...this.tankColors,[D]:R},D==="body"&&(this.selectedColor=R),C.querySelectorAll("div").forEach((et,nt)=>{const at=B[nt];et.style.borderColor=this.tankColors[D]===at?"#FFD700":"rgba(255,255,255,0.1)"}),this.renderTankPreview()}),C.appendChild(I)}w.appendChild(C),d.appendChild(w)}l.appendChild(d);const f=document.createElement("div");f.style.cssText=`
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    `;const p=document.createElement("div");p.textContent="PREVIEW",p.style.cssText=`
      font-size: 13px; letter-spacing: 2px; color: rgba(170,170,170,0.6);
    `,f.appendChild(p),this.previewCanvas=document.createElement("canvas"),this.previewCanvas.width=160,this.previewCanvas.height=160,this.previewCanvas.style.cssText=`
      border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
      background: rgba(0,0,0,0.3);
    `,f.appendChild(this.previewCanvas),l.appendChild(f),e.appendChild(l),this.renderTankPreview();const u=document.createElement("div");u.style.cssText="width: 100%; margin-bottom: 24px;";const g=document.createElement("div");g.textContent="SELECT MAP",g.style.cssText=`
      font-size: 15px; letter-spacing: 3px; color: rgba(170,170,170,0.7);
      margin-bottom: 10px; text-align: center;
    `,u.appendChild(g);const a=document.createElement("div");a.style.cssText="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;";for(const M of Ti){const w=document.createElement("button"),_=M.id===this.selectedMap;w.style.cssText=`
        padding: 14px 20px; font-size: 14px;
        border: 2px solid ${_?"rgba(255,215,0,0.6)":"rgba(255,255,255,0.1)"};
        background: ${_?"rgba(255,215,0,0.1)":"rgba(255,255,255,0.04)"};
        color: white; border-radius: 12px; cursor: pointer;
        min-width: 160px; transition: all 0.2s;
        font-family: 'Segoe UI', Arial, sans-serif;
        box-shadow: ${_?"0 0 15px rgba(255,215,0,0.15)":"none"};
      `,w.innerHTML=`
        <div style="font-weight: 700; font-size: 17px; margin-bottom: 4px;">${M.name}</div>
        <div style="color: rgba(170,170,170,0.8); font-size: 13px;">${M.description}</div>
        <div style="color: #FFD700; font-size: 12px; margin-top: 4px; opacity: 0.8;">★ ${M.botCount} bots</div>
      `,w.addEventListener("mouseenter",()=>{M.id!==this.selectedMap&&(w.style.borderColor="rgba(255,255,255,0.3)",w.style.background="rgba(255,255,255,0.08)")}),w.addEventListener("mouseleave",()=>{M.id!==this.selectedMap&&(w.style.borderColor="rgba(255,255,255,0.1)",w.style.background="rgba(255,255,255,0.04)")}),w.addEventListener("click",()=>{this.selectedMap=M.id,a.querySelectorAll("button").forEach(B=>{B.style.borderColor="rgba(255,255,255,0.1)",B.style.background="rgba(255,255,255,0.04)",B.style.boxShadow="none"}),w.style.borderColor="rgba(255,215,0,0.6)",w.style.background="rgba(255,215,0,0.1)",w.style.boxShadow="0 0 15px rgba(255,215,0,0.15)",this.ctfPanel&&(this.ctfPanel.style.display=M.id==="ctf"?"flex":"none")}),a.appendChild(w)}u.appendChild(a),e.appendChild(u),this.ctfPanel=document.createElement("div"),this.ctfPanel.style.cssText=`
      width: 100%; margin-bottom: 24px; display: ${this.selectedMap==="ctf"?"flex":"none"};
      flex-direction: column; align-items: center; gap: 14px;
      background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 18px;
    `;const y=document.createElement("div");y.textContent="НАСТРОЙКИ CTF",y.style.cssText="font-size: 15px; letter-spacing: 3px; color: rgba(170,170,170,0.7);",this.ctfPanel.appendChild(y);const b=document.createElement("div");b.style.cssText="display: flex; gap: 12px; align-items: center;";const v=document.createElement("div");v.textContent="Команда:",v.style.cssText="font-size: 14px; color: rgba(200,200,200,0.8);",b.appendChild(v);const S=document.createElement("button"),k=document.createElement("button"),T=()=>{S.style.cssText=`
        padding: 8px 20px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer;
        border: 2px solid ${this.ctfTeam==="a"?"#4488FF":"rgba(255,255,255,0.1)"};
        background: ${this.ctfTeam==="a"?"rgba(68,136,255,0.2)":"rgba(255,255,255,0.04)"};
        color: ${this.ctfTeam==="a"?"#4488FF":"#888"};
        font-family: 'Segoe UI', Arial, sans-serif;
      `,k.style.cssText=`
        padding: 8px 20px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer;
        border: 2px solid ${this.ctfTeam==="b"?"#FF4444":"rgba(255,255,255,0.1)"};
        background: ${this.ctfTeam==="b"?"rgba(255,68,68,0.2)":"rgba(255,255,255,0.04)"};
        color: ${this.ctfTeam==="b"?"#FF4444":"#888"};
        font-family: 'Segoe UI', Arial, sans-serif;
      `};S.textContent="Синие (A)",k.textContent="Красные (B)",S.addEventListener("click",()=>{this.ctfTeam="a",T()}),k.addEventListener("click",()=>{this.ctfTeam="b",T()}),T(),b.appendChild(S),b.appendChild(k),this.ctfPanel.appendChild(b);const F=(M,w,_)=>{const B=document.createElement("div");B.style.cssText="display: flex; gap: 10px; align-items: center;";const C=document.createElement("div");C.textContent=M,C.style.cssText="font-size: 14px; color: rgba(200,200,200,0.8); width: 160px; text-align: right;",B.appendChild(C);const R=document.createElement("button");R.textContent="-",R.style.cssText=`
        width: 32px; height: 32px; font-size: 18px; font-weight: bold;
        border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.06);
        color: white; border-radius: 6px; cursor: pointer; font-family: Arial;
      `;const I=document.createElement("div");I.textContent=`${w}`,I.style.cssText="font-size: 18px; font-weight: bold; color: #FFD700; width: 30px; text-align: center;";const D=document.createElement("button");D.textContent="+",D.style.cssText=R.style.cssText;let N=w;return R.addEventListener("click",()=>{N>0&&(N--,I.textContent=`${N}`,_(N))}),D.addEventListener("click",()=>{N<10&&(N++,I.textContent=`${N}`,_(N))}),B.appendChild(R),B.appendChild(I),B.appendChild(D),B};this.ctfPanel.appendChild(F("Боты в твоей команде:",this.ctfBotsA,M=>{this.ctfBotsA=M})),this.ctfPanel.appendChild(F("Боты противника:",this.ctfBotsB,M=>{this.ctfBotsB=M})),e.appendChild(this.ctfPanel);const E=document.createElement("button");E.textContent="PLAY",E.style.cssText=`
      padding: 18px 90px; font-size: 26px; font-weight: 800;
      border: none; border-radius: 16px; cursor: pointer;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #1a1a2e; letter-spacing: 4px;
      box-shadow: 0 4px 20px rgba(255,215,0,0.4);
      transition: transform 0.15s, box-shadow 0.15s;
      font-family: 'Segoe UI', Arial, sans-serif;
    `,E.addEventListener("mouseenter",()=>{E.style.boxShadow="0 6px 30px rgba(255,215,0,0.6)",E.style.transform="translateY(-2px)"}),E.addEventListener("mouseleave",()=>{E.style.boxShadow="0 4px 20px rgba(255,215,0,0.4)",E.style.transform="translateY(0)"}),E.addEventListener("mousedown",()=>{E.style.transform="scale(0.97)"}),E.addEventListener("mouseup",()=>{E.style.transform="scale(1)"}),E.addEventListener("click",()=>{var M,w,_;if(this.playerName=((M=this.nameInput)==null?void 0:M.value)||"Player",this.selectedColor=this.tankColors.body,localStorage.setItem("tankbr_name",this.playerName),localStorage.setItem("tankbr_map",this.selectedMap),localStorage.setItem("tankbr_color",this.selectedColor),localStorage.setItem("tankbr_colors",JSON.stringify(this.tankColors)),this.hide(),this.selectedMap==="ctf"){const B=this.ctfTeam==="a"?this.ctfBotsA:this.ctfBotsB,C=this.ctfTeam==="a"?this.ctfBotsB:this.ctfBotsA,R=this.ctfTeam==="a"?B:C,I=this.ctfTeam==="b"?B:C;(w=this.onJoin)==null||w.call(this,this.playerName,this.selectedMap,this.selectedColor,this.ctfTeam,R,I)}else(_=this.onJoin)==null||_.call(this,this.playerName,this.selectedMap,this.selectedColor)}),e.appendChild(E),this.container.appendChild(e),document.body.appendChild(this.container),this.nameInput.focus(),this.nameInput.addEventListener("keydown",M=>{M.key==="Enter"&&E.click()})}renderTankPreview(){if(!this.previewCanvas)return;const t=this.previewCanvas.getContext("2d"),e=this.previewCanvas.width,s=this.previewCanvas.height,i=e/2,n=s/2,r=40;t.clearRect(0,0,e,s);const h=this.tankColors;t.save(),t.globalAlpha=.3,t.fillStyle="#000",t.beginPath(),t.ellipse(i+3,n+3,r*1.1,r*.9,0,0,Math.PI*2),t.fill(),t.restore();const l=-.3;t.save(),t.translate(i,n),t.rotate(l);const d=t.createLinearGradient(-r,-r,-r,r);d.addColorStop(0,X(h.treads,-30)),d.addColorStop(.5,h.treads),d.addColorStop(1,X(h.treads,-40)),t.fillStyle=d,t.fillRect(-r*1.05,-r,r*.35,r*2),t.fillRect(r*.7,-r,r*.35,r*2),t.fillStyle=X(h.treads,-50);for(let g=0;g<6;g++){const a=-r+g/5*(r*2);t.beginPath(),t.arc(-r*.87,a,r*.05,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(r*.87,a,r*.05,0,Math.PI*2),t.fill()}const c=t.createLinearGradient(-r*.65,-r*.8,r*.65,r*.8);c.addColorStop(0,X(h.body,-15)),c.addColorStop(.3,h.body),c.addColorStop(.5,X(h.body,20)),c.addColorStop(.7,h.body),c.addColorStop(1,X(h.body,-10)),t.fillStyle=c,t.fillRect(-r*.65,-r*.8,r*1.3,r*1.6),t.strokeStyle=X(h.body,40),t.lineWidth=1.5,t.strokeRect(-r*.65,-r*.8,r*1.3,r*1.6),t.restore();const f=.2;t.save(),t.translate(i,n),t.rotate(f);const p=t.createRadialGradient(-r*.1,-r*.1,0,0,0,r*.4);p.addColorStop(0,X(h.turret,30)),p.addColorStop(.5,X(h.turret,-10)),p.addColorStop(1,X(h.turret,-40)),t.fillStyle=p,t.beginPath(),t.arc(0,0,r*.4,0,Math.PI*2),t.fill(),t.fillStyle="rgba(255,255,255,0.25)",t.beginPath(),t.arc(-r*.08,-r*.08,r*.12,0,Math.PI*2),t.fill();const u=t.createLinearGradient(-r*.12,0,r*.12,0);u.addColorStop(0,X(h.barrel,-30)),u.addColorStop(.5,h.barrel),u.addColorStop(1,X(h.barrel,-20)),t.fillStyle=u,t.fillRect(-r*.1,-r*1.2,r*.2,r*.8),t.fillStyle="#000",t.fillRect(-r*.1,-r*1.2,r*.2,r*.08),t.restore()}}function X(o,t){const e=parseInt(o.slice(1),16);if(isNaN(e))return o;const s=Math.max(0,Math.min(255,(e>>16&255)+t)),i=Math.max(0,Math.min(255,(e>>8&255)+t)),n=Math.max(0,Math.min(255,(e&255)+t));return`rgb(${s},${i},${n})`}var yt,ue;try{(ue=(yt=screen.orientation)==null?void 0:yt.lock)==null||ue.call(yt,"landscape").catch(()=>{})}catch{}const H=document.getElementById("game");H.tabIndex=1;H.style.outline="none";const L=new qe,z=new Ge;z.setCanvas(H);const $=new rs(H),kt=new vi,j=new ki(H),re=new Mi(H,z),ot=new _i(H),Y=document.createElement("button");Y.textContent="EXIT";Y.style.cssText=`
  position: fixed; top: 12px; right: 170px; z-index: 5;
  padding: 6px 16px; font-size: 13px; font-weight: bold;
  background: rgba(255, 50, 50, 0.7); color: #FFF;
  border: 1px solid rgba(255,255,255,0.3); border-radius: 6px;
  cursor: pointer; display: none; font-family: Arial, sans-serif;
`;Y.addEventListener("mouseenter",()=>{Y.style.background="rgba(255, 50, 50, 0.9)"});Y.addEventListener("mouseleave",()=>{Y.style.background="rgba(255, 50, 50, 0.7)"});document.body.appendChild(Y);let _e=0,x=!1,Wt=[],ae=performance.now(),Rt=0,Yt=null,zt=null;const le=50;let he=new Map,de=0,ce=0,It=0,Bt=0,fe=0,Ht=0,gt=0,Ot={x:0,y:0};"ontouchstart"in window&&H.addEventListener("touchstart",o=>{for(let t=0;t<o.changedTouches.length;t++){const e=o.changedTouches[t],s=H.getBoundingClientRect(),i=e.clientX-s.left,n=e.clientY-s.top;$.hitTestStuckButton(i,n)&&z.triggerUnstick()}},{passive:!0});function Ri(o,t,e,s,i,n){kt.clear(),_e=0,x=!1,$.setCustomTankColors(ot.customTankColors),tt.connected&&tt.join(o,t,e,s,i,n)}function dt(){Y.style.display="none",ot.show((o,t,e,s,i,n)=>{zt=null,Ri(o,t,e,s,i,n)},Yt??void 0,zt??void 0)}function Ii(){if(!x)return;const o=L.getMyTank();o&&o.isAlive&&$.effects.addExplosion(o.position.x,o.position.y),tt.leave(),x=!1,Y.style.display="none",$.effects.startFade("black"),setTimeout(()=>{j.show(0,Wt,()=>dt())},1500)}Y.addEventListener("click",Ii);const tt=new Si({onJoined(o){L.playerId=o.playerId,L.roomId=o.roomId,L.loadMap(o.mapData),$.loadMap(L),$.effects.reset(),j.hide(),ot.hide(),Y.style.display="block",H.focus(),x=!0;const t=o;t.accountStars!==void 0&&(Yt=t.accountStars)},onState(o){kt.push(o),Wt=o.leaderboard,Ht++},onKill(o){var e;const t=(e=L.state)==null?void 0:e.tanks.find(s=>s.id===o.deadId);t&&$.effects.addExplosion(t.position.x,t.position.y)},onPortalExit(o){if(o.playerId===L.playerId){Y.style.display="none",o.newAccountBalance!==void 0&&(Yt=o.newAccountBalance);const t=o.stars>0?"white":"black";$.effects.startFade(t),setTimeout(()=>{j.show(o.stars,Wt,()=>{dt()})},3e3)}},onGameOver(o){Y.style.display="none";const t=o.leaderboard.find(i=>i.id===L.playerId),e=(t==null?void 0:t.stars)??0,s=e>0?"white":"black";$.effects.startFade(s),setTimeout(()=>{j.show(e,o.leaderboard,()=>{dt()})},3e3)},onError(o){zt=o,x||dt()},onDisconnect(){x=!1,Y.style.display="none"}});tt.connect();dt();setInterval(()=>{tt.connected&&tt.ping()},5e3);function Re(o){var e;const t=Math.min((o-ae)/1e3,.1);if(ae=o,x&&!j.isVisible&&!ot.isVisible){z.updateCamera(L.camera.x,L.camera.y,$.currentCellPx);const s=L.getMyDisplayPosition();s&&z.updateMyPosition(s.x,s.y);const i=z.getMoveAngle(),n=z.getAimAngle();L.applyLocalInput(i,n,t);const r=L.getMyTank();if(r&&r.isAlive){const c=r.position.x-Ot.x,f=r.position.y-Ot.y;c*c+f*f<.01?gt+=t:gt=0,Ot={x:r.position.x,y:r.position.y}}else gt=0;if(Rt+=t*1e3,Rt>=le){Rt-=le;const c=z.consumeShopBuy(),f=z.consumeUnstick();tt.sendInput({tick:((e=L.state)==null?void 0:e.tick)??0,sequenceNumber:_e++,moveAngle:i,aimAngle:n,fire:z.isFiring(),shopBuy:c,unstick:f||void 0})}const h=z.isFiring(),l=performance.now();if(h){const c=L.getMyTank(),f=(c==null?void 0:c.activePowerUp)==="rapidFire"?Ne:$e;if(l-de>=f&&(de=l,$.effects.triggerRecoil(n),c)){const p=c.tankRadius*1.2,u=L.getMyDisplayPosition(),g=(u==null?void 0:u.x)??c.position.x,a=(u==null?void 0:u.y)??c.position.y,y=g+Math.sin(n)*p,b=a-Math.cos(n)*p;$.effects.addMuzzleFlash(y,b,n)}}const d=kt.getInterpolatedState();if(d){const c=new Map(d.bullets.map(f=>[f.id,f]));for(const[f,p]of he)c.has(f)||$.effects.addBulletImpact(p.position.x,p.position.y);he=c,L.updateState(d)}}if(ot.isVisible||(j.isVisible?j.render(H.getContext("2d")):($.setShopOpen(z.shopOpen),$.setStuckHint(gt>3,z.unstickCooldownRemaining),$.render(L),re.isActive&&re.render(H.getContext("2d")))),It++,Bt+=t,Bt>=1&&(ce=It,It=0,fe=Ht,Ht=0,Bt=0),x&&!ot.isVisible&&!j.isVisible){const s=H.getContext("2d"),i=kt.debugInfo,n=L.getMyTank(),r=L.predictedPos;let h=0;if(n&&r){const d=n.position.x-r.x,c=n.position.y-r.y;h=Math.sqrt(d*d+c*c)}const l=[`FPS: ${ce}`,`Ping: ${tt.currentLatency}ms`,`Packets/s: ${fe}`,`Buffer: ${i.bufferSize}`,`Mode: ${i.mode}`,`Pkt gap: ${Math.round(i.packetGapMs)}ms`,`Extrap: ${Math.round(i.extrapolateMs)}ms`,`Desync: ${h.toFixed(2)}`];s.save(),s.font="11px monospace",s.fillStyle="rgba(0,0,0,0.6)",s.fillRect(4,4,150,l.length*14+6),s.fillStyle="#0f0";for(let d=0;d<l.length;d++)s.fillText(l[d],8,16+d*14);s.restore()}requestAnimationFrame(Re)}requestAnimationFrame(Re);
